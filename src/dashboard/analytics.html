<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avtohabar - Tahlillar Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.0/index.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .metric-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .metric-card.green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .metric-card.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .metric-card.purple {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-truck text-white text-2xl mr-3"></i>
                    <span class="text-white text-xl font-bold">Avtohabar Analytics</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="periodSelector" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200">
                        <i class="fas fa-calendar mr-2"></i>
                        Bu oy
                    </button>
                    <button onclick="window.location.href='/dashboard'" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Dashboard
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 px-4">
        <!-- AI Insights Banner -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-6 mb-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">ðŸ¤– AI Dashboard</h2>
                    <p class="text-purple-100">Sun'iy intellekt tomonidan taqdim etilgan tahlillar va prognozlar</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold" id="aiConfidenceScore">87%</div>
                    <div class="text-purple-200">Prognoz ishonchliligi</div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <!-- Revenue Metric -->
            <div class="metric-card rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-opacity-80 text-sm">Umumiy daromad</p>
                        <h3 class="text-2xl font-bold" id="totalRevenue">â‚½ 0</h3>
                        <p class="text-white text-opacity-80 text-xs mt-1" id="revenueGrowth">+0% o'sish</p>
                    </div>
                    <i class="fas fa-money-bill-wave text-3xl text-white text-opacity-60"></i>
                </div>
            </div>

            <!-- Orders Metric -->
            <div class="metric-card blue rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-opacity-80 text-sm">Buyurtmalar soni</p>
                        <h3 class="text-2xl font-bold" id="totalOrders">0</h3>
                        <p class="text-white text-opacity-80 text-xs mt-1" id="ordersGrowth">+0% o'sish</p>
                    </div>
                    <i class="fas fa-shopping-cart text-3xl text-white text-opacity-60"></i>
                </div>
            </div>

            <!-- Success Rate Metric -->
            <div class="metric-card green rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-opacity-80 text-sm">Muvaffaqiyat darajasi</p>
                        <h3 class="text-2xl font-bold" id="successRate">0%</h3>
                        <p class="text-white text-opacity-80 text-xs mt-1" id="successRateChange">+0% yaxshi</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-white text-opacity-60"></i>
                </div>
            </div>

            <!-- Active Drivers -->
            <div class="metric-card orange rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-opacity-80 text-sm">Faol haydovchilar</p>
                        <h3 class="text-2xl font-bold" id="activeDrivers">0</h3>
                        <p class="text-white text-opacity-80 text-xs mt-1" id="driversChange">+0 yangi</p>
                    </div>
                    <i class="fas fa-users text-3xl text-white text-opacity-60"></i>
                </div>
            </div>

            <!-- AI Score -->
            <div class="metric-card purple rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">AI Optimallashtirish</p>
                        <h3 class="text-2xl font-bold text-gray-700" id="aiOptimization">0%</h3>
                        <p class="text-gray-600 text-xs mt-1">Samaradorlik</p>
                    </div>
                    <i class="fas fa-brain text-3xl text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Revenue Chart -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                        Daromad dinamikasi
                    </h3>
                    <div class="flex space-x-2">
                        <button class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">Haftalik</button>
                        <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-300">Oylik</button>
                    </div>
                </div>
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>

            <!-- Orders Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-pie-chart text-green-500 mr-2"></i>
                        Buyurtmalar taqsimoti
                    </h3>
                </div>
                <canvas id="ordersChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Detailed Analytics Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Payment Analytics -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-credit-card text-purple-500 mr-2"></i>
                    To'lov analytics
                </h3>
                <div id="paymentAnalytics" class="space-y-3">
                    <!-- Payment stats will be loaded here -->
                </div>
            </div>

            <!-- Driver Performance -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-tachometer-alt text-orange-500 mr-2"></i>
                    Haydovchilar samaradorligi
                </h3>
                <div id="driverPerformance" class="space-y-3">
                    <!-- Driver performance will be loaded here -->
                </div>
            </div>

            <!-- Route Optimization -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-route text-blue-500 mr-2"></i>
                    AI Marshrut optimallashtirish
                </h3>
                <div id="routeOptimization" class="space-y-3">
                    <!-- Route optimization data will be loaded here -->
                </div>
            </div>
        </div>

        <!-- AI Predictions Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-crystal-ball text-purple-500 mr-2"></i>
                AI Prognozlar va Tavsiyalar
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Demand Prediction -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h4 class="font-medium text-gray-800 mb-2">Talab prognozi</h4>
                    <canvas id="demandPredictionChart" width="400" height="150"></canvas>
                    <p class="text-sm text-gray-600 mt-2" id="demandInsight">AI tahlili asosida keyingi 7 kun uchun talab prognozi</p>
                </div>

                <!-- Business Recommendations -->
                <div class="border-l-4 border-green-500 pl-4">
                    <h4 class="font-medium text-gray-800 mb-2">Biznes tavsiyalar</h4>
                    <div id="businessRecommendations" class="space-y-2">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Updates Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Live Orders Feed -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-satellite-dish text-red-500 mr-2"></i>
                        Jonli buyurtmalar
                    </h3>
                    <div class="flex items-center text-green-500">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                        <span class="text-sm">LIVE</span>
                    </div>
                </div>
                <div id="liveOrdersFeed" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Live orders will be displayed here -->
                </div>
            </div>

            <!-- System Health -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                    Tizim holati
                </h3>
                <div id="systemHealth" class="space-y-4">
                    <!-- System health metrics will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Period Selection Modal -->
    <div id="periodModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4">Davr tanlash</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="period-btn p-3 text-left border rounded-lg hover:bg-blue-50" data-period="today">
                        <div class="font-medium">Bugun</div>
                        <div class="text-sm text-gray-600">Joriy kun</div>
                    </button>
                    <button class="period-btn p-3 text-left border rounded-lg hover:bg-blue-50" data-period="week">
                        <div class="font-medium">Bu hafta</div>
                        <div class="text-sm text-gray-600">Oxirgi 7 kun</div>
                    </button>
                    <button class="period-btn p-3 text-left border rounded-lg hover:bg-blue-50 bg-blue-50 border-blue-300" data-period="month">
                        <div class="font-medium">Bu oy</div>
                        <div class="text-sm text-gray-600">Joriy oy</div>
                    </button>
                    <button class="period-btn p-3 text-left border rounded-lg hover:bg-blue-50" data-period="quarter">
                        <div class="font-medium">Bu chorak</div>
                        <div class="text-sm text-gray-600">3 oy</div>
                    </button>
                    <button class="period-btn p-3 text-left border rounded-lg hover:bg-blue-50" data-period="year">
                        <div class="font-medium">Bu yil</div>
                        <div class="text-sm text-gray-600">Joriy yil</div>
                    </button>
                    <button class="period-btn p-3 text-left border rounded-lg hover:bg-blue-50" data-period="custom">
                        <div class="font-medium">Maxsus</div>
                        <div class="text-sm text-gray-600">Sana tanlash</div>
                    </button>
                </div>
                <div class="flex justify-end mt-6 space-x-3">
                    <button onclick="closePeriodModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Bekor qilish</button>
                    <button onclick="applyPeriod()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Qo'llash</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPeriod = 'month';
        let charts = {};
        let liveUpdateInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startLiveUpdates();
        });

        async function initializeDashboard() {
            showLoading();
            try {
                await Promise.all([
                    loadMetrics(),
                    loadCharts(),
                    loadDetailedAnalytics(),
                    loadAIPredictions(),
                    loadSystemHealth()
                ]);
                hideLoading();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showError('Dashboard ma\'lumotlarini yuklashda xatolik');
                hideLoading();
            }
        }

        async function loadMetrics() {
            try {
                // Load key metrics from different endpoints
                const [analytics, paymentData, driverData] = await Promise.all([
                    fetch('/api/dashboard/analytics?period=' + currentPeriod).then(r => r.json()),
                    fetch('/api/payment/analytics?period=' + currentPeriod).then(r => r.json()),
                    fetch('/api/dashboard/drivers/analytics?period=' + currentPeriod).then(r => r.json())
                ]);

                if (analytics.success) {
                    updateMetricCard('totalRevenue', formatCurrency(analytics.data.totalRevenue || 0), analytics.data.revenueGrowth || 0);
                    updateMetricCard('totalOrders', analytics.data.totalOrders || 0, analytics.data.ordersGrowth || 0);
                    updateMetricCard('successRate', (analytics.data.successRate || 0) + '%', analytics.data.successRateChange || 0);
                }

                if (driverData.success) {
                    updateMetricCard('activeDrivers', driverData.data.activeDrivers || 0, driverData.data.driversChange || 0);
                }

                // Update AI optimization score
                document.getElementById('aiOptimization').textContent = '94%';
                document.getElementById('aiConfidenceScore').textContent = '87%';

            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function updateMetricCard(id, value, change) {
            document.getElementById(id).textContent = value;

            const changeElement = document.getElementById(id.replace(/([A-Z])/g, function(match) {
                return match.toLowerCase();
            }) + (id.includes('Rate') ? 'Change' : 'Growth'));

            if (changeElement) {
                const sign = change >= 0 ? '+' : '';
                const suffix = id.includes('Rate') ? (change >= 0 ? '% yaxshi' : '% yomon') : '% o\'sish';
                changeElement.textContent = sign + change + suffix;
            }
        }

        async function loadCharts() {
            try {
                await Promise.all([
                    createRevenueChart(),
                    createOrdersChart()
                ]);
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        async function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');

            // Generate sample data for the last 30 days
            const data = generateSampleData(30);

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Daromad (UZS)',
                        data: data.revenue,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'AI Prognoz',
                        data: data.prediction,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        async function createOrdersChart() {
            const ctx = document.getElementById('ordersChart').getContext('2d');

            charts.orders = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Yakunlangan', 'Jarayonda', 'Bekor qilingan', 'Kutilmoqda'],
                    datasets: [{
                        data: [65, 20, 10, 5],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(239, 68, 68)',
                            'rgb(156, 163, 175)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadDetailedAnalytics() {
            try {
                await Promise.all([
                    loadPaymentAnalytics(),
                    loadDriverPerformance(),
                    loadRouteOptimization()
                ]);
            } catch (error) {
                console.error('Error loading detailed analytics:', error);
            }
        }

        async function loadPaymentAnalytics() {
            const container = document.getElementById('paymentAnalytics');

            const paymentData = [
                { method: 'Click', amount: 45000000, percentage: 65, growth: 12 },
                { method: 'Payme', amount: 25000000, percentage: 35, growth: 8 },
                { method: 'Naqd', amount: 5000000, percentage: 8, growth: -2 }
            ];

            container.innerHTML = paymentData.map(item => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                        <span class="font-medium">${item.method}</span>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${formatCurrency(item.amount)}</div>
                        <div class="text-sm text-gray-600">${item.percentage}% (+${item.growth}%)</div>
                    </div>
                </div>
            `).join('');
        }

        async function loadDriverPerformance() {
            const container = document.getElementById('driverPerformance');

            const driverData = [
                { name: 'Aziz Karimov', rating: 4.9, orders: 156, efficiency: 94 },
                { name: 'Bobur Umarov', rating: 4.7, orders: 142, efficiency: 91 },
                { name: 'Davron Nazarov', rating: 4.8, orders: 138, efficiency: 89 }
            ];

            container.innerHTML = driverData.map(driver => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium">${driver.name}</span>
                        <span class="text-yellow-500">â˜… ${driver.rating}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>Buyurtmalar: <span class="font-semibold">${driver.orders}</span></div>
                        <div>Samaradorlik: <span class="font-semibold">${driver.efficiency}%</span></div>
                    </div>
                </div>
            `).join('');
        }

        async function loadRouteOptimization() {
            const container = document.getElementById('routeOptimization');

            const routeData = [
                { route: 'Toshkent-Samarqand', optimized: 15, saved: '12 min', fuel: '8%' },
                { route: 'Toshkent-Buxoro', optimized: 8, saved: '18 min', fuel: '12%' },
                { route: 'Andijon-Fargona', optimized: 22, saved: '5 min', fuel: '6%' }
            ];

            container.innerHTML = routeData.map(route => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="font-medium mb-1">${route.route}</div>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <div class="text-center">
                            <div class="font-semibold text-blue-600">${route.optimized}</div>
                            <div class="text-gray-600">Optimallashtirish</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-green-600">${route.saved}</div>
                            <div class="text-gray-600">Vaqt tejash</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-orange-600">${route.fuel}</div>
                            <div class="text-gray-600">Yoqilg'i</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadAIPredictions() {
            try {
                await Promise.all([
                    createDemandPredictionChart(),
                    loadBusinessRecommendations()
                ]);
            } catch (error) {
                console.error('Error loading AI predictions:', error);
            }
        }

        async function createDemandPredictionChart() {
            const ctx = document.getElementById('demandPredictionChart').getContext('2d');

            const next7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() + i);
                return date.toLocaleDateString('uz-UZ', { weekday: 'short' });
            });

            const demandData = [45, 52, 38, 41, 47, 55, 49]; // Sample prediction data

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: next7Days,
                    datasets: [{
                        label: 'Prognoz qilingan buyurtmalar',
                        data: demandData,
                        backgroundColor: 'rgba(168, 85, 247, 0.8)',
                        borderColor: 'rgb(168, 85, 247)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Update insight text
            const totalPredicted = demandData.reduce((a, b) => a + b, 0);
            document.getElementById('demandInsight').textContent =
                `Keyingi hafta uchun ${totalPredicted} ta buyurtma prognoz qilinmoqda (o'rtacha ${Math.round(totalPredicted/7)} ta/kun)`;
        }

        async function loadBusinessRecommendations() {
            const container = document.getElementById('businessRecommendations');

            const recommendations = [
                { icon: 'ðŸ“ˆ', text: 'Juma kuni talabni qondirish uchun 2 ta qo\'shimcha haydovchi jalb qiling', priority: 'high' },
                { icon: 'âš¡', text: 'Toshkent-Samarqand yo\'nalishida narxlarni 5% oshiring', priority: 'medium' },
                { icon: 'ðŸŽ¯', text: 'Yangi mijozlar uchun chegirma kampaniyasi o\'tkazing', priority: 'low' },
                { icon: 'ðŸ”„', text: 'AI marshrut optimallashtirish har kuni 15% yoqilg\'i tejaydi', priority: 'info' }
            ];

            container.innerHTML = recommendations.map(rec => `
                <div class="flex items-start space-x-3 p-2 rounded-lg hover:bg-gray-50">
                    <span class="text-lg">${rec.icon}</span>
                    <div class="flex-1">
                        <p class="text-sm">${rec.text}</p>
                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full ${getPriorityColor(rec.priority)}">
                            ${getPriorityText(rec.priority)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function getPriorityColor(priority) {
            const colors = {
                high: 'bg-red-100 text-red-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-blue-100 text-blue-800',
                info: 'bg-green-100 text-green-800'
            };
            return colors[priority] || colors.info;
        }

        function getPriorityText(priority) {
            const texts = {
                high: 'Yuqori',
                medium: 'O\'rta',
                low: 'Past',
                info: 'Ma\'lumot'
            };
            return texts[priority] || texts.info;
        }

        async function loadSystemHealth() {
            const container = document.getElementById('systemHealth');

            const healthMetrics = [
                { name: 'API Server', status: 'healthy', uptime: '99.9%', responseTime: '45ms' },
                { name: 'Database', status: 'healthy', uptime: '99.8%', responseTime: '12ms' },
                { name: 'Payment Gateway', status: 'warning', uptime: '98.5%', responseTime: '156ms' },
                { name: 'AI Services', status: 'healthy', uptime: '99.7%', responseTime: '89ms' }
            ];

            container.innerHTML = healthMetrics.map(metric => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-3 h-3 ${getStatusColor(metric.status)} rounded-full mr-3"></div>
                        <span class="font-medium">${metric.name}</span>
                    </div>
                    <div class="text-right text-sm">
                        <div>${metric.uptime} uptime</div>
                        <div class="text-gray-600">${metric.responseTime}</div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                healthy: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            return colors[status] || colors.error;
        }

        function startLiveUpdates() {
            // Load initial live orders
            loadLiveOrders();

            // Update every 30 seconds
            liveUpdateInterval = setInterval(() => {
                loadLiveOrders();
                updateMetrics();
            }, 30000);
        }

        async function loadLiveOrders() {
            try {
                const response = await fetch('/api/dashboard/live-orders');
                if (response.ok) {
                    const data = await response.json();
                    updateLiveOrdersFeed(data.orders || []);
                }
            } catch (error) {
                console.error('Error loading live orders:', error);
            }
        }

        function updateLiveOrdersFeed(orders) {
            const container = document.getElementById('liveOrdersFeed');

            if (!orders.length) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">Hozirda yangi buyurtmalar yo\'q</div>';
                return;
            }

            container.innerHTML = orders.slice(0, 10).map(order => `
                <div class="p-3 border-l-4 border-blue-500 bg-blue-50 rounded">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium">${order.id}</span>
                        <span class="text-xs text-gray-600">${formatTime(order.createdAt)}</span>
                    </div>
                    <div class="text-sm text-gray-700">
                        ${order.fromCity} â†’ ${order.toCity}
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${formatCurrency(order.price)} â€¢ ${order.status}
                    </div>
                </div>
            `).join('');
        }

        function updateMetrics() {
            // Simulate real-time metric updates
            const elements = ['totalRevenue', 'totalOrders', 'successRate', 'activeDrivers'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element && !element.textContent.includes('%')) {
                    const currentValue = parseInt(element.textContent.replace(/[^\d]/g, '')) || 0;
                    const variation = Math.floor(Math.random() * 5) - 2; // -2 to +2 variation
                    const newValue = Math.max(0, currentValue + variation);

                    if (id === 'totalRevenue') {
                        element.textContent = formatCurrency(newValue);
                    } else {
                        element.textContent = newValue;
                    }
                }
            });
        }

        // Period selection functions
        document.getElementById('periodSelector').addEventListener('click', function() {
            document.getElementById('periodModal').classList.remove('hidden');
        });

        function closePeriodModal() {
            document.getElementById('periodModal').classList.add('hidden');
        }

        function applyPeriod() {
            const selected = document.querySelector('.period-btn.bg-blue-50');
            if (selected) {
                currentPeriod = selected.dataset.period;
                updatePeriodSelector();
                closePeriodModal();
                initializeDashboard();
            }
        }

        function updatePeriodSelector() {
            const periodTexts = {
                today: 'Bugun',
                week: 'Bu hafta',
                month: 'Bu oy',
                quarter: 'Bu chorak',
                year: 'Bu yil',
                custom: 'Maxsus'
            };

            document.getElementById('periodSelector').innerHTML = `
                <i class="fas fa-calendar mr-2"></i>
                ${periodTexts[currentPeriod]}
            `;
        }

        // Period selection buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.period-btn')) {
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'border-blue-300');
                });
                e.target.closest('.period-btn').classList.add('bg-blue-50', 'border-blue-300');
            }
        });

        // Utility functions
        function generateSampleData(days) {
            const labels = [];
            const revenue = [];
            const prediction = [];

            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' }));

                const baseRevenue = 2000000 + Math.random() * 1000000;
                revenue.push(Math.round(baseRevenue));

                if (i <= 7) { // Prediction for next 7 days
                    prediction.push(Math.round(baseRevenue * (1.05 + Math.random() * 0.1)));
                } else {
                    prediction.push(null);
                }
            }

            return { labels, revenue, prediction };
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('uz-UZ', {
                style: 'currency',
                currency: 'UZS',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('UZS', 'so\'m');
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('uz-UZ', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            // Add loading indicators to charts and content
        }

        function hideLoading() {
            // Remove loading indicators
        }

        function showError(message) {
            console.error(message);
            // Could show toast notification here
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
            }
        });
    </script>
</body>
</html>