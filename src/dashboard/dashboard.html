<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiMaster Pro | Professional Logistika Boshqaruv Tizimi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            --blue-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --green-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --orange-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #e0f2fe 50%, #f3e8ff 100%);
            min-height: 100vh;
            color: var(--gray-900);
        }

        /* Enhanced Header */
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            max-width: 100%;
            height: 80px;
            min-height: 80px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            position: relative;
            width: 3rem;
            height: 3rem;
            background: var(--primary-gradient);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 1rem;
            height: 1rem;
            background: linear-gradient(135deg, #10b981, #3b82f6);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .logo-text h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .logo-text p {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            height: 100%;
        }

        .search-container {
            position: relative;
            width: 320px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid var(--gray-200);
            border-radius: 1rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.8);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .notification-btn {
            position: relative;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 1rem;
            color: var(--gray-600);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.8);
            color: var(--gray-900);
            transform: translateY(-1px);
        }

        .notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .user-avatar {
            position: relative;
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, #10b981, #3b82f6);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 1rem;
            height: 1rem;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid white;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            border-radius: 0.75rem;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }

        .logout-btn:active {
            transform: translateY(0);
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.08);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .sidebar-content {
            padding: 2rem;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: none;
            background: none;
            border-radius: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-item:hover::before {
            opacity: 0.1;
        }

        .nav-item.active::before {
            opacity: 1;
        }

        .nav-item:hover {
            color: var(--gray-900);
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-item.active {
            color: white;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
            transform: scale(1.02);
        }

        .nav-icon {
            width: 1.5rem;
            height: 1.5rem;
            position: relative;
            z-index: 1;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
        }

        .nav-item.active .nav-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-label {
            position: relative;
            z-index: 1;
            font-size: 0.875rem;
        }

        /* Enhanced Stats Cards */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(59, 130, 246, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .stat-info h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: #059669;
            background: rgba(16, 185, 129, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
        }

        .stat-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            position: relative;
            z-index: 1;
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #2563eb;
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
        }

        .stat-icon.green {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #059669;
            box-shadow: 0 8px 32px rgba(5, 150, 105, 0.3);
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, #e9d5ff, #ddd6fe);
            color: #7c3aed;
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.3);
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: #d97706;
            box-shadow: 0 8px 32px rgba(217, 119, 6, 0.3);
        }

        /* Content Cards */
        .content-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .content-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .content-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.5);
            color: var(--gray-700);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-1px);
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }

        .custom-table thead th {
            background: rgba(0, 0, 0, 0.02);
            padding: 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .custom-table tbody td {
            padding: 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            vertical-align: middle;
        }

        .custom-table tbody tr {
            transition: all 0.3s ease;
        }

        .custom-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .status-active {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }

        .status-pending {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-color: #f59e0b;
        }

        .status-completed {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border-color: #3b82f6;
        }

        /* Live Activity */
        .live-activity {
            margin-top: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .live-activity-title {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--gray-900);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(4px);
        }

        .activity-indicator {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .activity-indicator.green { background: #10b981; }
        .activity-indicator.blue { background: #3b82f6; }
        .activity-indicator.yellow { background: #f59e0b; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 0;
                transform: translateX(-100%);
                position: fixed;
                height: 100vh;
                z-index: 1001;
            }

            .sidebar.open {
                width: 320px;
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .search-container {
                width: 200px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
                gap: 1rem;
                padding: 1rem;
            }

            .search-container {
                width: 100%;
                order: 3;
            }

            .logo-text h1 {
                font-size: 1.5rem;
            }

            .logo-text p {
                display: none;
            }

            .user-details {
                display: none;
            }

            .time-display {
                display: none;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-50: #1f2937;
                --gray-100: #374151;
                --gray-200: #4b5563;
                --gray-300: #6b7280;
                --gray-400: #9ca3af;
                --gray-500: #d1d5db;
                --gray-600: #e5e7eb;
                --gray-700: #f3f4f6;
                --gray-800: #f9fafb;
                --gray-900: #ffffff;
            }

            body {
                background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #1e1b4b 100%);
            }
        }

        /* Animations */
        @keyframes slideInFromLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .stat-card {
            animation: fadeInUp 0.6s ease-out;
        }

        .nav-item {
            animation: slideInFromLeft 0.3s ease-out;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }

        /* Autocomplete styles */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.15s ease;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.highlighted {
            background-color: #3b82f6;
            color: white;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="logo-text">
                    <h1>LogiMaster Pro</h1>
                    <p>
                        <i class="fas fa-wifi" style="font-size: 0.7rem;"></i>
                        Professional logistika boshqaruv tizimi
                    </p>
                </div>
            </div>

            <div class="header-actions">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Qidirish... (Ctrl+K)" id="globalSearch">
                    <i class="fas fa-search search-icon"></i>
                </div>

                <div class="time-display">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime">--:--</span>
                </div>

                <button class="notification-btn" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>

                <div class="user-info">
                    <div class="user-details">
                        <p class="user-name">Super Admin</p>
                        <p class="user-role">
                            <i class="fas fa-shield-alt"></i>
                            Barcha huquqlar
                        </p>
                    </div>
                    <button class="logout-btn" id="logoutBtn" onclick="logout()" title="Chiqish">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <div class="user-avatar">
                        SA
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <div class="nav-menu">
                    <button class="nav-item active" data-page="dashboard">
                        <div class="nav-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <span class="nav-label">Bosh sahifa</span>
                    </button>
                    <button class="nav-item" data-page="orders">
                        <div class="nav-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <span class="nav-label">Buyurtmalar nazorati</span>
                    </button>
                    <button class="nav-item" data-page="drivers">
                        <div class="nav-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <span class="nav-label">Haydovchilar</span>
                    </button>
                    <button class="nav-item" data-page="dispatchers">
                        <div class="nav-icon">
                            <i class="fas fa-headphones"></i>
                        </div>
                        <span class="nav-label">Dispecherlar</span>
                    </button>
                    <button class="nav-item" data-page="customers">
                        <div class="nav-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <span class="nav-label">Mijozlar</span>
                    </button>
                    <button class="nav-item" data-page="staff" onclick="window.location.href='/dashboard/staff'">
                        <div class="nav-icon">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <span class="nav-label">Xodimlar</span>
                    </button>
                    <button class="nav-item" data-page="finance">
                        <div class="nav-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <span class="nav-label">Moliyaviy hisobotlar</span>
                    </button>
                    <button class="nav-item" data-page="history">
                        <div class="nav-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <span class="nav-label">Buyurtmalar tarixi</span>
                    </button>
                    <button class="nav-item" data-page="analytics">
                        <div class="nav-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <span class="nav-label">Analitika</span>
                    </button>
                    <button class="nav-item" data-page="employees">
                        <div class="nav-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <span class="nav-label">Xodimlar</span>
                    </button>
                    <button class="nav-item" data-page="roles">
                        <div class="nav-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span class="nav-label">Rollar va huquqlar</span>
                    </button>
                    <button class="nav-item" data-page="support">
                        <div class="nav-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <span class="nav-label">Qo'llab-quvvatlash</span>
                    </button>
                    <button class="nav-item" data-page="locations">
                        <div class="nav-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <span class="nav-label">Lokatsiyalar</span>
                    </button>
                    <button class="nav-item" data-page="settings">
                        <div class="nav-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span class="nav-label">Sozlamalar</span>
                    </button>
                </div>

                <!-- Live Activity -->
                <div class="live-activity">
                    <h4 class="live-activity-title">
                        <i class="fas fa-bolt"></i>
                        Jonli faollik
                    </h4>
                    <div class="activity-item">
                        <div class="activity-indicator green"></div>
                        <div>
                            <p style="font-weight: 600; font-size: 0.875rem; margin: 0;">Faol haydovchilar</p>
                            <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;" id="liveDrivers">89</p>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-indicator blue"></div>
                        <div>
                            <p style="font-weight: 600; font-size: 0.875rem; margin: 0;">Bugungi buyurtmalar</p>
                            <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;" id="liveOrders">247</p>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-indicator yellow"></div>
                        <div>
                            <p style="font-weight: 600; font-size: 0.875rem; margin: 0;">Bugungi daromad</p>
                            <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;" id="liveRevenue">‚ÇΩ24,567</p>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dynamic Content Area -->
            <div id="contentArea">
                <!-- Content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Scripts -->
    <script>
        // LogiMaster Pro Enhanced Dashboard - Inline version
        class LogiMasterDashboard {
            constructor() {
                // Restore current page from localStorage or default to 'dashboard'
                this.currentPage = localStorage.getItem('dashboardCurrentPage') || 'dashboard';
                this.searchTerm = '';
                this.sidebarCollapsed = false;
                this.currentTime = new Date();
                this.showModal = false;
                this.modalType = '';
                this.selectedItem = null;
                this.formData = {};
                this.callActive = false;
                this.currentCall = null;
                this.apiData = {};

                // Order history filters
                this.orderHistoryFilters = {
                    status: 'all', // 'all', 'completed', 'cancelled'
                    source: 'all', // 'all', 'yukchi', 'dispechr', 'admin'
                    dateRange: 'all' // 'all', 'today', 'week', 'month'
                };

                // Initialize WebSocket connection
                this.initializeWebSocket();

                this.init();
            }

            async init() {
                console.log('üöÄ Dashboard initializing...');
                await this.loadApiData();
                this.setupEventListeners();
                this.loadPage(this.currentPage);
                this.updateLiveStats();
                this.startRealTimeUpdates();
                this.updateTime();
            }

            async loadApiData() {
                console.log('üîÑ Loading API data...');
                try {
                    console.log('üìä Fetching stats...');
                    const statsResponse = await fetch('/api/dashboard/stats');
                    const statsData = await statsResponse.json();
                    console.log('‚úÖ Stats loaded:', statsData);

                    console.log('üìã Fetching orders...');
                    const ordersResponse = await fetch('/api/dashboard/orders?limit=1000');
                    const ordersData = await ordersResponse.json();
                    console.log('‚úÖ Orders loaded:', ordersData.data?.length || 0, 'orders');

                    console.log('üë®‚Äçüíº Fetching drivers...');
                    const driversResponse = await fetch('/api/dashboard/drivers');
                    const driversData = await driversResponse.json();
                    console.log('‚úÖ Drivers loaded:', driversData.data?.length || 0, 'drivers');

                    console.log('üéß Fetching dispatchers...');
                    const dispatchersResponse = await fetch('/api/dashboard/dispatchers');
                    const dispatchersData = await dispatchersResponse.json();
                    console.log('‚úÖ Dispatchers loaded:', dispatchersData.data?.length || 0, 'dispatchers');

                    console.log('üë• Fetching customers...');
                    const customersResponse = await fetch('/api/dashboard/customers');
                    const customersData = await customersResponse.json();
                    console.log('‚úÖ Customers response:', customersData);
                    console.log('‚úÖ Customers loaded:', customersData.data?.length || 0, 'customers');

                    console.log('üí≥ Fetching payments...');
                    const paymentsResponse = await fetch('/api/dashboard/payments');
                    const paymentsData = await paymentsResponse.json();
                    console.log('‚úÖ Payments loaded:', paymentsData.data?.length || 0, 'payments');

                    this.apiData = {
                        stats: statsData.success ? statsData.data : this.getDefaultStats(),
                        orders: ordersData.success ? ordersData.data : [],
                        drivers: driversData.success ? driversData.data : [],
                        dispatchers: dispatchersData.success ? dispatchersData.data : [],
                        customers: customersData.success ? customersData.data : [],
                        payments: paymentsData.success ? paymentsData.data : []
                    };

                    console.log('‚úÖ API data loaded successfully', this.apiData);
                } catch (error) {
                    console.error('‚ùå Error loading API data:', error);
                    this.apiData = {
                        stats: this.getDefaultStats(),
                        orders: [],
                        drivers: [],
                        dispatchers: [],
                        customers: [],
                        payments: []
                    };
                }
            }

            getDefaultStats() {
                return {
                    orders: 247,
                    drivers: 89,
                    dispatchers: 8,
                    customers: 156,
                    revenue: 2400000,
                    completedOrders: 177
                };
            }

            setupEventListeners() {
                console.log('üîß Setting up event listeners...');

                const navItems = document.querySelectorAll('.nav-item');
                console.log('Found nav items:', navItems.length);

                navItems.forEach((item, index) => {
                    const page = item.getAttribute('data-page');
                    console.log('Setting up listener for nav item:', page);
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('üñ±Ô∏è Clicked navigation item:', page);

                        // Immediately update active state for visual feedback
                        this.setActivePage(page);

                        // Load the page content
                        this.loadPage(page);

                        // Show notification for user feedback
                        this.showNotification(`${this.getPageDisplayName(page)} sahifasi yuklanmoqda...`, 'info');
                    });
                });

                const searchInput = document.getElementById('globalSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.handleSearch();
                    });

                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 'k') {
                            e.preventDefault();
                            searchInput.focus();
                        }
                    });
                }

                const notificationBtn = document.getElementById('notificationBtn');
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', () => {
                        this.showNotifications();
                    });
                }
            }

            setActivePage(page) {
                console.log('üéØ Setting active page:', page);

                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Add active class to current page
                const activeItem = document.querySelector('[data-page="' + page + '"]');
                if (activeItem) {
                    activeItem.classList.add('active');
                    console.log('‚úÖ Active class added to:', page);
                } else {
                    console.error('‚ùå Nav item not found for page:', page);
                }

                this.currentPage = page;
                // Save current page to localStorage
                localStorage.setItem('dashboardCurrentPage', page);
            }

            async loadPage(page) {
                console.log('üìÑ Loading page:', page);
                const contentArea = document.getElementById('contentArea');
                if (!contentArea) {
                    console.error('‚ùå ContentArea element not found!');
                    return;
                }

                // Show loading state
                contentArea.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 200px; color: #6b7280;">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Ma'lumotlar yuklanmoqda...</p>
                        </div>
                    </div>
                `;

                let content = '';

                switch(page) {
                    case 'dashboard':
                        console.log('üè† Rendering dashboard...');
                        content = this.renderDashboard();
                        break;
                    case 'orders':
                        console.log('üì¶ Rendering orders...');
                        content = this.renderOrders();
                        break;
                    case 'drivers':
                        console.log('üöó Rendering drivers...');
                        content = this.renderDrivers();
                        // Setup button events after render
                        setTimeout(() => this.setupDriverButtonEvents(), 100);
                        break;
                    case 'dispatchers':
                        console.log('üéß Rendering dispatchers...');
                        content = this.renderDispatchers();
                        break;
                    case 'customers':
                        console.log('üë• Rendering customers...');
                        content = this.renderCustomers();
                        break;
                    case 'history':
                        console.log('üìö Rendering order history...');
                        content = this.renderOrderHistory();
                        break;
                    case 'locations':
                        console.log('üó∫Ô∏è Rendering locations...');
                        content = this.renderLocations();
                        // Setup location events after render
                        setTimeout(() => {
                            this.setupLocationEvents();
                            this.setupLocationModalEvents();
                        }, 100);
                        break;
                    default:
                        console.log('üîß Rendering coming soon for:', page);
                        content = this.renderComingSoon(page);
                }

                // Render immediately
                try {
                    contentArea.innerHTML = content;
                    console.log('‚úÖ Page content loaded for:', page);

                    // Force a render for customers page specifically
                    if (page === 'customers') {
                        console.log('üîß Force rendering customers with data:', this.apiData.customers);
                    }
                } catch (renderError) {
                    console.error('‚ùå Error rendering content:', renderError);
                    contentArea.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc2626;">
                            <h3>Xatolik yuz berdi</h3>
                            <p>Sahifani ko'rsatishda muammo: ${renderError.message}</p>
                            <button onclick="dashboard.refreshCustomers()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; margin-top: 1rem; cursor: pointer;">
                                Qayta urinish
                            </button>
                        </div>
                    `;
                }
            }

            renderDashboard() {
                const stats = this.apiData.stats || this.getDefaultStats();
                return `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <h3>Faol buyurtmalar</h3>
                                    <div class="stat-value">${stats.orders}</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+18% so'nggi oyga nisbatan</span>
                                    </div>
                                </div>
                                <div class="stat-icon blue">
                                    <i class="fas fa-box"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <h3>Faol haydovchilar</h3>
                                    <div class="stat-value">${stats.drivers}</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+12% so'nggi oyga nisbatan</span>
                                    </div>
                                </div>
                                <div class="stat-icon green">
                                    <i class="fas fa-car"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <h3>Bugungi daromad</h3>
                                    <div class="stat-value">${this.formatCurrency(stats.revenue)}</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+24% so'nggi oyga nisbatan</span>
                                    </div>
                                </div>
                                <div class="stat-icon purple">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <h3>Xodimlar</h3>
                                    <div class="stat-value">${stats.staff || 1}</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>Staff Management Faol</span>
                                    </div>
                                </div>
                                <div class="stat-icon orange">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Enterprise Modules Section -->
                    <div class="content-card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h2><i class="fas fa-rocket"></i> Enterprise Xususiyatlari</h2>
                            <p>Yangi qo'shilgan professional modullar</p>
                        </div>
                        <div class="enterprise-modules" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">

                            <!-- Commission Management -->
                            <div class="module-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 1rem; cursor: pointer; transition: transform 0.3s ease; position: relative;" onclick="showCommissionManagement()"
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.2rem;">üí∞ Komissiya</h3>
                                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Haydovchi to'lovlari</p>
                                    </div>
                                    <i class="fas fa-percentage" style="font-size: 2rem; opacity: 0.8;"></i>
                                </div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">
                                    ‚úì Komissiya foizlari<br>
                                    ‚úì Haydovchi hisoboti<br>
                                    ‚úì Avtomatik hisob-kitob
                                </div>
                                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; text-align: center; font-size: 0.8rem;">
                                    <strong>Boshqarish ‚Üí</strong>
                                </div>
                            </div>

                            <!-- Finance Dashboard -->
                            <div class="module-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 1rem; cursor: pointer; transition: transform 0.3s ease;" onclick="showFinanceDashboard()"
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.2rem;">üìä Moliya</h3>
                                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Daromad va xarajatlar</p>
                                    </div>
                                    <i class="fas fa-chart-line" style="font-size: 2rem; opacity: 0.8;"></i>
                                </div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">
                                    ‚úì Kunlik hisobotlar<br>
                                    ‚úì Daromad tahlili<br>
                                    ‚úì Xarajatlar kuzatuvi
                                </div>
                                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; text-align: center; font-size: 0.8rem;">
                                    <strong>Sahifaga o'tish ‚Üí</strong>
                                </div>
                            </div>

                            <!-- Staff Management -->
                            <div class="module-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 1rem; cursor: pointer; transition: transform 0.3s ease;" onclick="window.location.href='/dashboard/staff'">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.2rem;">üë• Xodimlar</h3>
                                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Jamoani boshqarish</p>
                                    </div>
                                    <i class="fas fa-users-cog" style="font-size: 2rem; opacity: 0.8;"></i>
                                </div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">
                                    ‚úì Rollar va huquqlar<br>
                                    ‚úì Bo'limlar boshqaruvi<br>
                                    ‚úì Faoliyat kuzatuvi
                                </div>
                                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; text-align: center; font-size: 0.8rem;">
                                    <strong>Sahifaga o'tish ‚Üí</strong>
                                </div>
                            </div>

                            <!-- Driver Payments -->
                            <div class="module-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.5rem; border-radius: 1rem; cursor: pointer; transition: transform 0.3s ease;" onclick="dashboard.openDriverPayments()">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.2rem;">üöó Haydovchi To'lovlari</h3>
                                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Balans va hisob-kitob</p>
                                    </div>
                                    <i class="fas fa-wallet" style="font-size: 2rem; opacity: 0.8;"></i>
                                </div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">
                                    ‚úì Balans ko'rish<br>
                                    ‚úì To'lov tarixi<br>
                                    ‚úì Pul yechish
                                </div>
                                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; text-align: center; font-size: 0.8rem;">
                                    <strong>Boshqarish ‚Üí</strong>
                                </div>
                            </div>

                            <!-- Order History -->
                            <div class="module-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 1rem; cursor: pointer; transition: transform 0.3s ease;" onclick="window.location.href='/dashboard/history.html'">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.2rem;">üìö Buyurtmalar Tarixi</h3>
                                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">To'liq hisobotlar</p>
                                    </div>
                                    <i class="fas fa-history" style="font-size: 2rem; opacity: 0.8;"></i>
                                </div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">
                                    ‚úì Barcha buyurtmalar<br>
                                    ‚úì Filtrlar va qidiruv<br>
                                    ‚úì Excel eksport
                                </div>
                                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; text-align: center; font-size: 0.8rem;">
                                    <strong>Sahifaga o'tish ‚Üí</strong>
                                </div>
                            </div>

                            <!-- Settings & Config -->
                            <div class="module-card" style="background: linear-gradient(135deg, #434343 0%, #000000 100%); color: white; padding: 1.5rem; border-radius: 1rem; cursor: pointer; transition: transform 0.3s ease;" onclick="dashboard.openSettingsModal()">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.2rem;">‚öôÔ∏è Sozlamalar</h3>
                                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Tizim konfiguratsiyasi</p>
                                    </div>
                                    <i class="fas fa-cogs" style="font-size: 2rem; opacity: 0.8;"></i>
                                </div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">
                                    ‚úì Bot sozlamalari<br>
                                    ‚úì Narxlar va tariflar<br>
                                    ‚úì Telegram integratsiya
                                </div>
                                <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; text-align: center; font-size: 0.8rem;">
                                    <strong>Boshqarish ‚Üí</strong>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="content-card">
                        <div class="content-header">
                            <h3 class="content-title">So'nggi faollik</h3>
                            <div class="content-actions">
                                <button class="btn-secondary" onclick="dashboard.refreshActivity()">
                                    <i class="fas fa-refresh"></i>
                                    <span>Yangilash</span>
                                </button>
                            </div>
                        </div>
                        <div style="padding: 2rem;">
                            <p>Dashboard ma'lumotlari yuklanmoqda...</p>
                        </div>
                    </div>
                `;
            }

            renderOrders() {
                // Faqat faol buyurtmalarni ko'rsatish (active, matched, pending)
                const allOrders = this.apiData.orders || [];
                const orders = allOrders.filter(order =>
                    order.status === 'active' ||
                    order.status === 'matched' ||
                    order.status === 'pending'
                );
                console.log('üì¶ Rendering orders:', orders.length);

                if (orders.length === 0) {
                    return `
                        <div class="content-card">
                            <div class="content-header">
                                <h2 class="content-title">Buyurtmalar nazorati</h2>
                                <div class="content-actions">
                                    <button class="btn-primary" onclick="dashboard.openNewOrderModal()">
                                        <i class="fas fa-plus"></i>
                                        <span>Yangi buyurtma</span>
                                    </button>
                                    <button class="btn-secondary" onclick="dashboard.refreshOrders()">
                                        <i class="fas fa-refresh"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="padding: 2rem; text-align: center;">
                                <div style="width: 5rem; height: 5rem; border-radius: 1rem; background: #f3f4f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                    <i class="fas fa-box" style="font-size: 2rem;"></i>
                                </div>
                                <h3 style="color: #374151; margin-bottom: 0.5rem;">Buyurtmalar topilmadi</h3>
                                <p style="color: #6b7280;">Hali hech qanday buyurtma berilmagan</p>
                                <button class="btn-primary" onclick="dashboard.openNewOrderModal()" style="margin-top: 1rem;">
                                    <i class="fas fa-plus"></i>
                                    Birinchi buyurtmani yarating
                                </button>
                            </div>
                        </div>
                    `;
                }

                const getStatusBadge = (status) => {
                    const statusMap = {
                        'active': { color: '#3b82f6', bg: '#dbeafe', text: 'Faol' },
                        'matched': { color: '#10b981', bg: '#d1fae5', text: 'Haydovchi topildi' },
                        'pending': { color: '#f59e0b', bg: '#fef3c7', text: 'Kutilmoqda' }
                    };
                    const s = statusMap[status] || statusMap['active'];
                    return `<span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; background: ${s.bg}; color: ${s.color};">${s.text}</span>`;
                };

                const getOrderSource = (order) => {
                    // Determine who placed the order based on available data
                    if (order.source) return order.source;
                    if (order.createdBy) return order.createdBy;
                    if (order.via) return order.via;
                    // Default logic based on ID patterns or other indicators
                    return 'Dashboard'; // Default for dashboard-created orders
                };

                const ordersTable = orders.map(order => `
                    <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #6366f1; margin-bottom: 0.25rem;">${getOrderSource(order)}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Buyurtma manbai</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600; color: #111827; margin-bottom: 0.25rem;">${order.route}</div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">${order.cargoType}</div>
                            <div style="font-size: 0.75rem; color: #9ca3af;">üì¶ ${order.customer}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 700; color: #059669; font-size: 1.1rem;">${this.formatCurrency(order.amount)}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">${order.date}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${order.driver || 'Kutilmoqda...'}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">üöõ Haydovchi</div>
                        </td>
                        <td style="padding: 1rem;">
                            ${getStatusBadge(order.status)}
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-secondary" onclick="dashboard.viewOrderDetails('${order.id}')" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem;" title="Ko'rish">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-danger" onclick="dashboard.cancelOrder('${order.id}')" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; cursor: pointer;" title="Bekor qilish">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn-warning" onclick="dashboard.resendOrder('${order.id}')" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 0.375rem; cursor: pointer;" title="Qayta yuborish">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                const statusCounts = orders.reduce((acc, order) => {
                    acc[order.status] = (acc[order.status] || 0) + 1;
                    return acc;
                }, {});

                return `
                    <div class="content-card">
                        <div class="content-header">
                            <h2 class="content-title">Buyurtmalar nazorati</h2>
                            <div class="content-actions">
                                <button class="btn-primary" onclick="dashboard.openNewOrderModal()">
                                    <i class="fas fa-plus"></i>
                                    <span>Yangi buyurtma</span>
                                </button>
                                <button class="btn-secondary" onclick="dashboard.refreshOrders()">
                                    <i class="fas fa-refresh"></i>
                                    <span>Yangilash</span>
                                </button>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                <div style="background: #dbeafe; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.25rem;">${statusCounts.active || 0}</div>
                                    <div style="font-size: 0.875rem; color: #1e40af; font-weight: 500;">Faol buyurtmalar</div>
                                </div>
                                <div style="background: #d1fae5; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.25rem;">${statusCounts.matched || 0}</div>
                                    <div style="font-size: 0.875rem; color: #065f46; font-weight: 500;">Haydovchi topildi</div>
                                </div>
                                <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b; margin-bottom: 0.25rem;">${statusCounts.pending || 0}</div>
                                    <div style="font-size: 0.875rem; color: #92400e; font-weight: 500;">Kutilmoqda</div>
                                </div>
                                <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280; margin-bottom: 0.25rem;">${allOrders.length}</div>
                                    <div style="font-size: 0.875rem; color: #374151; font-weight: 500;">Jami buyurtmalar</div>
                                </div>
                            </div>

                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üìã Buyurtma manbai</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üöö Marshrut va Yuk tafsilotlari</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üí∞ Summa</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üöõ Haydovchi</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üìä Holat</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">‚öôÔ∏è Amallar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ordersTable}
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                                <div style="color: #6b7280; font-size: 0.875rem;">
                                    Jami: ${orders.length} ta buyurtma
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderOrderHistory() {
                // Get all orders for history - only completed and cancelled orders
                const allOrders = this.apiData.orders || [];
                const historyOrders = allOrders.filter(order =>
                    order.status === 'completed' || order.status === 'cancelled'
                );

                // Apply current filters
                let orders = this.applyOrderHistoryFilters(historyOrders);

                console.log('üìö Rendering order history:', orders.length);

                if (orders.length === 0) {
                    return `
                        <div class="content-card">
                            <div class="content-header">
                                <h2 class="content-title">Buyurtmalar tarixi</h2>
                            </div>
                            <div style="padding: 2rem; text-align: center;">
                                <div style="width: 5rem; height: 5rem; border-radius: 1rem; background: #f3f4f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                    <i class="fas fa-history" style="font-size: 2rem;"></i>
                                </div>
                                <h3 style="color: #374151; margin-bottom: 0.5rem;">Tarix topilmadi</h3>
                                <p style="color: #6b7280;">Hali hech qanday buyurtma yakunlanmagan</p>
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')" style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                            </div>
                        </div>
                    `;
                }

                const getHistoryStatusBadge = (status) => {
                    const statusMap = {
                        'completed': { color: '#059669', bg: '#a7f3d0', text: 'Yakunlandi' },
                        'cancelled': { color: '#ef4444', bg: '#fee2e2', text: 'Bekor qilindi' }
                    };
                    const s = statusMap[status] || statusMap['completed'];
                    return `<span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; background: ${s.bg}; color: ${s.color};">${s.text}</span>`;
                };

                const historyTable = orders.map(order => `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${this.getOrderSource(order)}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${order.customer}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${order.route}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${order.cargoType}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600; color: #111827;">${this.formatCurrency(order.amount)}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${order.driver}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Haydovchi</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${this.formatPhoneNumber(order.phone)}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Telefon</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-size: 0.875rem; color: #6b7280;">${order.date}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-size: 0.875rem; color: #6b7280;">${order.time || '00:00'}</div>
                        </td>
                        <td style="padding: 1rem;">
                            ${getHistoryStatusBadge(order.status)}
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600; color: #374151; font-size: 0.875rem;">${order.id}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <button class="btn-secondary" onclick="dashboard.viewOrderDetails('${order.id}')" style="padding: 0.5rem; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                const statusCounts = orders.reduce((acc, order) => {
                    acc[order.status] = (acc[order.status] || 0) + 1;
                    return acc;
                }, {});

                return `
                    <div class="content-card">
                        <div class="content-header">
                            <h2 class="content-title">Buyurtmalar tarixi</h2>
                            <div class="content-actions">
                                <button class="btn-secondary" onclick="dashboard.refreshOrderHistory()">
                                    <i class="fas fa-refresh"></i>
                                    <span>Yangilash</span>
                                </button>
                                <button class="btn-secondary" onclick="dashboard.loadPage('orders')">
                                    <i class="fas fa-arrow-left"></i>
                                    <span>Faol buyurtmalarga</span>
                                </button>
                            </div>
                        </div>

                        <!-- Filter buttons -->
                        <div style="padding: 0 1.5rem 1rem 1.5rem;">
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="filter-btn ${this.orderHistoryFilters.status === 'all' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('status', 'all')">Jami</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.status === 'completed' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('status', 'completed')">Yakunlangan</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.status === 'cancelled' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('status', 'cancelled')">Bekor qilingan</button>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="filter-btn ${this.orderHistoryFilters.source === 'all' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('source', 'all')">Barcha manba</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.source === 'yukchi' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('source', 'yukchi')">Yukchidan</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.source === 'dispechr' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('source', 'dispechr')">Dispechrdan</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.source === 'admin' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('source', 'admin')">Admindan</button>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="filter-btn ${this.orderHistoryFilters.dateRange === 'all' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('dateRange', 'all')">Barcha sana</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.dateRange === 'today' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('dateRange', 'today')">Bugun</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.dateRange === 'week' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('dateRange', 'week')">Bu hafta</button>
                                    <button class="filter-btn ${this.orderHistoryFilters.dateRange === 'month' ? 'active' : ''}" onclick="dashboard.setHistoryFilter('dateRange', 'month')">Bu oy</button>
                                </div>
                                <div style="margin-left: auto;">
                                    <button class="btn-secondary" onclick="dashboard.clearAllHistoryFilters()" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500;">
                                        <i class="fas fa-filter-circle-xmark"></i>
                                        Barcha filtrlarni tozalash
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                <div style="background: #a7f3d0; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #059669; margin-bottom: 0.25rem;">${statusCounts.completed || 0}</div>
                                    <div style="font-size: 0.875rem; color: #065f46; font-weight: 500;">Yakunlangan</div>
                                </div>
                                <div style="background: #fee2e2; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444; margin-bottom: 0.25rem;">${statusCounts.cancelled || 0}</div>
                                    <div style="font-size: 0.875rem; color: #dc2626; font-weight: 500;">Bekor qilingan</div>
                                </div>
                                <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280; margin-bottom: 0.25rem;">${orders.length}</div>
                                    <div style="font-size: 0.875rem; color: #374151; font-weight: 500;">Jami</div>
                                </div>
                                <div style="background: #e0f2fe; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #0277bd; margin-bottom: 0.25rem;">${allOrders.length}</div>
                                    <div style="font-size: 0.875rem; color: #01579b; font-weight: 500;">Barcha buyurtmalar</div>
                                </div>
                            </div>

                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Kimni zakazi</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Marshrut va Yuk</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Summa</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Haydovchi</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Telefon</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Sana</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Vaqt</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Holat</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Buyurtma ID</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Amallar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${historyTable}
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                                <div style="color: #6b7280; font-size: 0.875rem;">
                                    Jami: ${orders.length} ta yakunlangan buyurtma
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderDrivers() {
                const drivers = this.apiData.drivers || [];
                console.log('üìä Rendering drivers:', drivers.length, 'found');

                if (drivers.length === 0) {
                    return `
                        <div class="content-card">
                            <div class="content-header">
                                <h2 class="content-title">Haydovchilar boshqaruvi</h2>
                            </div>
                            <div style="padding: 2rem; text-align: center;">
                                <div style="width: 5rem; height: 5rem; border-radius: 1rem; background: #f3f4f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                    <i class="fas fa-users" style="font-size: 2rem;"></i>
                                </div>
                                <h3 style="color: #374151; margin-bottom: 0.5rem;">Haydovchilar topilmadi</h3>
                                <p style="color: #6b7280;">Hali hech qanday haydovchi ro'yxatdan o'tmagan</p>
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')" style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                            </div>
                        </div>
                    `;
                }

                const driversTable = drivers.map(driver => `
                    <tr style="transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-size: 0.875rem; font-weight: 600;">
                                    ${driver.fullName ? driver.fullName.split(' ').map(n => n[0]).join('').toUpperCase() : driver.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #111827; margin-bottom: 0.25rem;">${driver.fullName || driver.name}</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">${driver.id}</div>
                                    <div style="font-size: 0.75rem; color: #9ca3af;">üöõ ${driver.vehicle}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${this.formatPhoneNumber(driver.phone)}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">üìû Telefon</div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-weight: 600; color: #059669; font-size: 1.1rem;">${this.formatCurrency(driver.balance)}</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="balance-btn" data-driver-id="${driver.realId || driver.id}" data-driver-name="${driver.fullName || driver.name || 'Haydovchi'}" style="background: #10b981; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; flex: 1;" onmouseover="this.style.backgroundColor='#059669'" onmouseout="this.style.backgroundColor='#10b981'">
                                        üí∞ To'ldirish
                                    </button>
                                    <button class="penalty-btn" data-driver-id="${driver.realId || driver.id}" data-driver-name="${driver.fullName || driver.name || 'Haydovchi'}" style="background: #dc2626; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; flex: 1;" onmouseover="this.style.backgroundColor='#b91c1c'" onmouseout="this.style.backgroundColor='#dc2626'">
                                        ‚ö†Ô∏è Jarima
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-weight: 500; color: #374151;">${driver.orders}</div>
                                <button class="driver-orders-btn" data-driver-id="${driver.realId || driver.id}" data-driver-name="${driver.fullName || driver.name}" style="background: #3b82f6; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#2563eb'" onmouseout="this.style.backgroundColor='#3b82f6'">
                                    üìã Buyurtmalar tarixi
                                </button>
                            </div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-weight: 600; color: #059669; font-size: 1rem; margin-bottom: 0.25rem;">${this.formatCurrency(driver.totalCommission || 0)}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">üíµ Komisya</div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                                <i class="fas fa-star" style="color: #fbbf24; margin-right: 0.25rem;"></i>
                                <span style="font-weight: 500; color: #374151;">${driver.rating.toFixed(1)}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">‚≠ê Reyting</div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <span style="padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; background: #dcfce7; color: #166534;">
                                üü¢ Faol
                            </span>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-secondary" onclick="dashboard.viewDriverDetails('${driver.id}')" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem;" title="Ma'lumotlar">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-secondary" onclick="dashboard.callDriver('${driver.phone}')" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer;" title="Qo'ng'iroq">
                                    <i class="fas fa-phone"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                return `
                    <div class="content-card">
                        <div class="content-header">
                            <h2 class="content-title">Haydovchilar boshqaruvi</h2>
                            <div class="content-actions">
                                <button class="btn-primary" onclick="dashboard.openAddDriverModal()">
                                    <i class="fas fa-plus"></i>
                                    <span>Haydovchi qo'shish</span>
                                </button>
                                <button class="btn-secondary" onclick="dashboard.refreshDrivers()">
                                    <i class="fas fa-refresh"></i>
                                    <span>Yangilash</span>
                                </button>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="color: #1f2937; margin: 0 0 0.25rem 0;">Bot'dan ro'yxatdan o'tgan haydovchilar</h4>
                                        <p style="color: #6b7280; margin: 0; font-size: 0.875rem;">Real foydalanuvchilar ma'lumotlari</p>
                                    </div>
                                    <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">${drivers.length}</div>
                                </div>
                            </div>

                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üë®‚Äçüíº Haydovchi ma'lumotlari</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üìû Telefon</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üí∞ Balans / Amallar</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üì¶ Buyurtmalar</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">üíµ Jami komisya</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">‚≠ê Reyting</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Holat</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Amallar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${driversTable}
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                                <div style="color: #6b7280; font-size: 0.875rem;">
                                    Jami: ${drivers.length} ta haydovchi
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            setupGlobalEventDelegation() {
                console.log('üåê Setting up global event delegation for driver buttons...');

                // Use event delegation - attach listeners to document body (once only)
                document.body.addEventListener('click', (e) => {
                    // Handle balance button clicks
                    if (e.target.classList.contains('balance-btn') || e.target.closest('.balance-btn')) {
                        e.preventDefault();
                        console.log('üéØ Balance button clicked via delegation!', e.target);
                        const button = e.target.closest('.balance-btn');
                        if (button) {
                            const driverId = button.dataset.driverId;
                            const driverName = button.dataset.driverName;
                            console.log('Balance Data:', { driverId, driverName });
                            this.openBalanceTopUpModal(driverId, driverName);
                        }
                    }

                    // Handle penalty button clicks
                    if (e.target.classList.contains('penalty-btn') || e.target.closest('.penalty-btn')) {
                        e.preventDefault();
                        console.log('‚ö†Ô∏è Penalty button clicked via delegation!', e.target);
                        const button = e.target.closest('.penalty-btn');
                        if (button) {
                            const driverId = button.dataset.driverId;
                            const driverName = button.dataset.driverName;
                            console.log('Penalty Data:', { driverId, driverName });
                            this.openPenaltyDeductModal(driverId, driverName);
                        }
                    }

                    // Handle driver orders button clicks
                    if (e.target.classList.contains('driver-orders-btn') || e.target.closest('.driver-orders-btn')) {
                        e.preventDefault();
                        console.log('üìã Driver orders button clicked via delegation!', e.target);
                        const button = e.target.closest('.driver-orders-btn');
                        if (button) {
                            const driverId = button.dataset.driverId;
                            const driverName = button.dataset.driverName;
                            console.log('Driver Orders Data:', { driverId, driverName });
                            openDriverOrdersModal(driverId, driverName);
                        }
                    }

                    // Handle modal cancel button clicks
                    if (e.target.classList.contains('modal-cancel-btn')) {
                        e.preventDefault();
                        console.log('‚ùå Modal cancel button clicked');
                        const modal = e.target.closest('[style*="position: fixed"]');
                        if (modal) {
                            modal.remove();
                        }
                    }

                    // Handle modal balance submit button clicks
                    if (e.target.classList.contains('modal-balance-submit-btn')) {
                        e.preventDefault();
                        console.log('üí∞ Modal balance submit button clicked');
                        const button = e.target;
                        const driverId = button.dataset.driverId;
                        const driverName = button.dataset.driverName;
                        this.processBalanceTopUp(driverId, driverName, button);
                    }

                    // Handle modal penalty submit button clicks
                    if (e.target.classList.contains('modal-penalty-submit-btn')) {
                        e.preventDefault();
                        console.log('‚ö†Ô∏è Modal penalty submit button clicked');
                        const button = e.target;
                        const driverId = button.dataset.driverId;
                        const driverName = button.dataset.driverName;
                        this.processPenaltyDeduct(driverId, driverName, button);
                    }
                });

                console.log('‚úÖ Global event delegation setup complete');
            }

            setupDriverButtonEvents() {
                // This method is no longer needed since we use global event delegation
                console.log('üìù Driver button events handled by global delegation');
            }

            setupLocationEvents() {
                console.log('üó∫Ô∏è Setting up location events...');

                // Initialize map if not exists
                if (!window.locationsMap) {
                    this.initializeLocationsMap();
                }

                // Load locations data
                this.loadLocationsData();
            }

            initializeLocationsMap() {
                console.log('üó∫Ô∏è Initializing locations map...');

                // Wait for Leaflet to be available
                const initMap = () => {
                    if (typeof L !== 'undefined') {
                        this.createMap();
                    } else {
                        console.log('‚è≥ Waiting for Leaflet...');
                        setTimeout(initMap, 100);
                    }
                };

                initMap();
            }

            createMap() {
                const mapContainer = document.getElementById('locationsMap');
                if (!mapContainer) {
                    console.error('‚ùå Map container not found!');
                    return;
                }

                console.log('üó∫Ô∏è Creating map in container:', mapContainer);

                try {
                    // Initialize map centered on Uzbekistan
                    window.locationsMap = L.map('locationsMap', {
                        center: [41.2995, 64.5853],
                        zoom: 6,
                        zoomControl: true,
                        attributionControl: true
                    });

                    // Add tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18,
                        minZoom: 4
                    }).addTo(window.locationsMap);

                    // Initialize markers array
                    window.locationMarkers = [];

                    console.log('‚úÖ Map initialized successfully');

                    // Force map to update its size
                    setTimeout(() => {
                        window.locationsMap.invalidateSize();
                        console.log('üîÑ Map size updated');
                    }, 250);

                } catch (error) {
                    console.error('‚ùå Error creating map:', error);
                }
            }

            async loadLocationsData() {
                try {
                    // Try to load from API first
                    const response = await fetch('/api/dashboard/locations');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data && result.data.regions) {
                            this.allLocations = result.data.regions;
                            this.processLocationsFromAPI();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('üì° API not available, using local data');
                }

                // Fallback to comprehensive local data
                this.allLocations = [
                    {
                        id: 'tashkent_city',
                        name: 'Toshkent shahri',
                        type: 'city',
                        coordinates: [41.2995, 69.2401],
                        districts: [
                            { name: 'Bektemir tumani', coordinates: [41.2076, 69.3394] },
                            { name: 'Chilonzor tumani', coordinates: [41.2750, 69.2036] },
                            { name: 'Yakkasaroy tumani', coordinates: [41.2889, 69.2348] },
                            { name: 'Mirobod tumani', coordinates: [41.2856, 69.2734] },
                            { name: 'Mirzo Ulugbek tumani', coordinates: [41.3142, 69.2348] },
                            { name: 'Sergeli tumani', coordinates: [41.2286, 69.2348] },
                            { name: 'Shayxontohur tumani', coordinates: [41.3266, 69.2401] },
                            { name: 'Olmazor tumani', coordinates: [41.3142, 69.2036] },
                            { name: 'Uchtepa tumani', coordinates: [41.2889, 69.1724] },
                            { name: 'Yunusobod tumani', coordinates: [41.3578, 69.2890] },
                            { name: 'Yashnobod tumani', coordinates: [41.3578, 69.3394] }
                        ]
                    },
                    {
                        id: 'tashkent_region',
                        name: 'Toshkent viloyati',
                        type: 'region',
                        coordinates: [41.0000, 69.0000],
                        districts: [
                            { name: 'Angren shahri', coordinates: [41.0167, 70.1444] },
                            { name: 'Bekobod shahri', coordinates: [40.2167, 69.2667] },
                            { name: 'Chirchiq shahri', coordinates: [41.4667, 69.5833] },
                            { name: 'Olmaliq shahri', coordinates: [40.8444, 69.5972] },
                            { name: 'Ohangaron shahri', coordinates: [40.9167, 69.6333] },
                            { name: 'Yangiobod tumani', coordinates: [41.1167, 70.1167] },
                            { name: 'Piskent tumani', coordinates: [41.0333, 69.3333] },
                            { name: 'Qibray tumani', coordinates: [41.3833, 69.4833] },
                            { name: 'Zangiota tumani', coordinates: [41.1167, 69.2833] },
                            { name: 'Yuqorichirchiq tumani', coordinates: [41.5833, 70.0833] },
                            { name: 'Parkent tumani', coordinates: [41.2833, 69.6667] },
                            { name: 'Chinoz tumani', coordinates: [40.9333, 68.7667] },
                            { name: 'Quyichirchiq tumani', coordinates: [41.4667, 69.4833] },
                            { name: 'Ortachirchiq tumani', coordinates: [41.5000, 69.7833] },
                            { name: 'Bostonliq tumani', coordinates: [41.2167, 70.0167] }
                        ]
                    },
                    {
                        id: 'samarkand',
                        name: 'Samarqand viloyati',
                        type: 'region',
                        coordinates: [39.6542, 66.9597],
                        districts: [
                            { name: 'Samarqand shahri', coordinates: [39.6542, 66.9597] },
                            { name: 'Kattaqo\'rg\'on shahri', coordinates: [39.8833, 66.2667] },
                            { name: 'Jomboy tumani', coordinates: [39.7167, 67.1167] },
                            { name: 'Urgut tumani', coordinates: [39.4000, 67.2333] },
                            { name: 'Bulung\'ur tumani', coordinates: [39.7667, 67.2667] },
                            { name: 'Ishtixon tumani', coordinates: [39.9167, 66.8833] },
                            { name: 'Koshrabot tumani', coordinates: [39.5000, 66.8167] },
                            { name: 'Narpay tumani', coordinates: [39.5833, 66.7667] },
                            { name: 'Nurobod tumani', coordinates: [39.9833, 67.5667] },
                            { name: 'Oqdaryo tumani', coordinates: [39.9167, 67.2000] },
                            { name: 'Pastdarg\'om tumani', coordinates: [39.8167, 67.6667] },
                            { name: 'Payariq tumani', coordinates: [39.4667, 67.0167] },
                            { name: 'Toyloq tumani', coordinates: [39.9833, 66.6000] }
                        ]
                    },
                    {
                        id: 'bukhara',
                        name: 'Buxoro viloyati',
                        type: 'region',
                        coordinates: [39.7747, 64.4286],
                        districts: [
                            { name: 'Buxoro shahri', coordinates: [39.7747, 64.4286] },
                            { name: 'Olot tumani', coordinates: [40.4500, 64.4333] },
                            { name: 'G\'ijduvon tumani', coordinates: [40.1000, 64.6833] },
                            { name: 'Jondor tumani', coordinates: [39.0833, 64.0667] },
                            { name: 'Kogon tumani', coordinates: [39.7167, 64.5500] },
                            { name: 'Qorako\'l tumani', coordinates: [39.5500, 63.8333] },
                            { name: 'Peshku tumani', coordinates: [40.0333, 63.8500] },
                            { name: 'Romitan tumani', coordinates: [39.9667, 64.3833] },
                            { name: 'Shofirkon tumani', coordinates: [39.9833, 64.5167] },
                            { name: 'Vobkent tumani', coordinates: [40.0167, 64.5333] }
                        ]
                    },
                    {
                        id: 'navoi',
                        name: 'Navoiy viloyati',
                        type: 'region',
                        coordinates: [40.0844, 65.3792],
                        districts: [
                            { name: 'Navoiy shahri', coordinates: [40.0844, 65.3792] },
                            { name: 'Zarafshon shahri', coordinates: [41.5700, 64.2100] },
                            { name: 'Karmana tumani', coordinates: [40.2833, 65.2167] },
                            { name: 'Konimex tumani', coordinates: [40.6167, 65.1667] },
                            { name: 'Navbahor tumani', coordinates: [39.7333, 65.1333] },
                            { name: 'Nurota tumani', coordinates: [40.5667, 65.6833] },
                            { name: 'Tomdi tumani', coordinates: [40.0833, 65.1000] },
                            { name: 'Uchquduq tumani', coordinates: [42.1333, 63.5500] },
                            { name: 'Xatirchi tumani', coordinates: [39.7500, 65.9833] }
                        ]
                    },
                    {
                        id: 'andijan',
                        name: 'Andijon viloyati',
                        type: 'region',
                        coordinates: [40.7821, 72.3442],
                        districts: [
                            { name: 'Andijon shahri', coordinates: [40.7821, 72.3442] },
                            { name: 'Asaka tumani', coordinates: [40.6333, 72.2333] },
                            { name: 'Baliqchi tumani', coordinates: [40.8833, 72.1167] },
                            { name: 'Bo\'z tumani', coordinates: [40.8167, 71.7500] },
                            { name: 'Buloqboshi tumani', coordinates: [40.9667, 71.9333] },
                            { name: 'Izboskan tumani', coordinates: [40.9167, 72.2000] },
                            { name: 'Jalaquduq tumani', coordinates: [40.9167, 72.5833] },
                            { name: 'Marhamat tumani', coordinates: [40.4833, 72.3000] },
                            { name: 'Oltinko\'l tumani', coordinates: [40.7833, 72.1833] },
                            { name: 'Pakhtaobod tumani', coordinates: [40.6167, 72.3833] },
                            { name: 'Qo\'rg\'ontepa tumani', coordinates: [40.7333, 72.4667] },
                            { name: 'Shahrixon tumani', coordinates: [40.7167, 72.0833] },
                            { name: 'Ulug\'nor tumani', coordinates: [40.8333, 72.6333] },
                            { name: 'Xo\'jaobod tumani', coordinates: [40.6500, 71.9667] }
                        ]
                    },
                    {
                        id: 'fergana',
                        name: 'Farg\'ona viloyati',
                        type: 'region',
                        coordinates: [40.3842, 71.7843],
                        districts: [
                            { name: 'Farg\'ona shahri', coordinates: [40.3842, 71.7843] },
                            { name: 'Marg\'ilon shahri', coordinates: [40.4667, 71.7167] },
                            { name: 'Quvasoy shahri', coordinates: [40.2833, 71.9833] },
                            { name: 'Qo\'qon shahri', coordinates: [40.5333, 70.9333] },
                            { name: 'Beshariq tumani', coordinates: [40.4333, 70.6167] },
                            { name: 'Bog\'dod tumani', coordinates: [40.3167, 71.5333] },
                            { name: 'Buvayda tumani', coordinates: [40.6167, 71.0500] },
                            { name: 'Dang\'ara tumani', coordinates: [40.4833, 70.9000] },
                            { name: 'Farg\'ona tumani', coordinates: [40.2833, 71.6667] },
                            { name: 'Furqat tumani', coordinates: [40.1167, 71.8833] },
                            { name: 'O\'zbekiston tumani', coordinates: [40.1333, 71.0667] },
                            { name: 'Qo\'shtepa tumani', coordinates: [40.6667, 71.6833] },
                            { name: 'Rishton tumani', coordinates: [40.3500, 71.5500] },
                            { name: 'So\'x tumani', coordinates: [40.2833, 71.1333] },
                            { name: 'Toshloq tumani', coordinates: [40.4167, 71.4833] },
                            { name: 'Uchko\'prik tumani', coordinates: [40.2000, 71.4333] },
                            { name: 'Yozyovon tumani', coordinates: [40.2500, 71.9167] }
                        ]
                    },
                    {
                        id: 'namangan',
                        name: 'Namangan viloyati',
                        type: 'region',
                        coordinates: [41.0000, 71.6726],
                        districts: [
                            { name: 'Namangan shahri', coordinates: [41.0000, 71.6726] },
                            { name: 'Chortoq tumani', coordinates: [40.9333, 71.8167] },
                            { name: 'Chust tumani', coordinates: [41.0000, 71.2333] },
                            { name: 'Kosonsoy tumani', coordinates: [41.2167, 71.5500] },
                            { name: 'Mingbuloq tumani', coordinates: [41.2667, 71.7333] },
                            { name: 'Namangan tumani', coordinates: [40.9167, 71.5167] },
                            { name: 'Norin tumani', coordinates: [41.3000, 71.4333] },
                            { name: 'Pop tumani', coordinates: [40.8667, 71.1167] },
                            { name: 'To\'raqo\'rg\'on tumani', coordinates: [40.8333, 71.8833] },
                            { name: 'Uchqo\'rg\'on tumani', coordinates: [40.7667, 72.0000] },
                            { name: 'Uychi tumani', coordinates: [41.0833, 71.9667] },
                            { name: 'Yangiqo\'rg\'on tumani', coordinates: [40.9500, 71.7167] }
                        ]
                    },
                    {
                        id: 'kashkadarya',
                        name: 'Qashqadaryo viloyati',
                        type: 'region',
                        coordinates: [38.8597, 65.7975],
                        districts: [
                            { name: 'Qarshi shahri', coordinates: [38.8597, 65.7975] },
                            { name: 'Shahrisabz shahri', coordinates: [39.0500, 66.8333] },
                            { name: 'Chiroqchi tumani', coordinates: [39.0167, 66.5500] },
                            { name: 'Dehqonobod tumani', coordinates: [38.2833, 66.0833] },
                            { name: 'G\'uzor tumani', coordinates: [38.6167, 66.2500] },
                            { name: 'Kasbi tumani', coordinates: [38.5167, 66.2167] },
                            { name: 'Kitob tumani', coordinates: [39.1833, 67.2667] },
                            { name: 'Koson tumani', coordinates: [39.0333, 65.4000] },
                            { name: 'Mirishkor tumani', coordinates: [39.0167, 66.1000] },
                            { name: 'Muborak tumani', coordinates: [38.7833, 65.3667] },
                            { name: 'Nishon tumani', coordinates: [38.9667, 65.8667] },
                            { name: 'Qamashi tumani', coordinates: [38.8500, 66.4833] },
                            { name: 'Qarshi tumani', coordinates: [38.7833, 65.9167] },
                            { name: 'Shahrisabz tumani', coordinates: [39.0000, 66.7667] },
                            { name: 'Yakkabog\' tumani', coordinates: [38.6500, 66.9000] }
                        ]
                    },
                    {
                        id: 'surkhandarya',
                        name: 'Surxondaryo viloyati',
                        type: 'region',
                        coordinates: [37.9394, 67.5694],
                        districts: [
                            { name: 'Termiz shahri', coordinates: [37.2242, 67.2783] },
                            { name: 'Angor tumani', coordinates: [38.0667, 67.5167] },
                            { name: 'Bandixon tumani', coordinates: [37.9500, 68.0833] },
                            { name: 'Boysun tumani', coordinates: [38.2167, 67.2000] },
                            { name: 'Denov tumani', coordinates: [38.2667, 67.9000] },
                            { name: 'Jarqo\'rg\'on tumani', coordinates: [37.8333, 67.4500] },
                            { name: 'Qiziriq tumani', coordinates: [37.6167, 67.7667] },
                            { name: 'Qo\'mqo\'rg\'on tumani', coordinates: [37.9167, 67.4833] },
                            { name: 'Sariosiyo tumani', coordinates: [37.9833, 67.1333] },
                            { name: 'Sherobod tumani', coordinates: [37.7167, 67.0167] },
                            { name: 'Sho\'rchi tumani', coordinates: [37.9833, 67.7833] },
                            { name: 'Termiz tumani', coordinates: [37.2667, 67.3333] },
                            { name: 'Uzun tumani', coordinates: [38.0167, 67.8667] }
                        ]
                    },
                    {
                        id: 'khorezm',
                        name: 'Xorazm viloyati',
                        type: 'region',
                        coordinates: [41.5269, 60.3725],
                        districts: [
                            { name: 'Urganch shahri', coordinates: [41.5500, 60.6333] },
                            { name: 'Xiva shahri', coordinates: [41.3842, 60.3625] },
                            { name: 'Bag\'at tumani', coordinates: [41.2500, 60.1333] },
                            { name: 'Gurlan tumani', coordinates: [41.8500, 60.3833] },
                            { name: 'Qo\'shko\'pir tumani', coordinates: [41.4667, 60.3167] },
                            { name: 'Shovot tumani', coordinates: [41.6833, 60.1167] },
                            { name: 'Urganch tumani', coordinates: [41.5833, 60.6000] },
                            { name: 'Xonqa tumani', coordinates: [41.3000, 60.9000] },
                            { name: 'Xazorasp tumani', coordinates: [41.3167, 61.0833] },
                            { name: 'Yangiariq tumani', coordinates: [41.2167, 60.3667] },
                            { name: 'Yangibozor tumani', coordinates: [41.7167, 60.4833] }
                        ]
                    },
                    {
                        id: 'jizzakh',
                        name: 'Jizzax viloyati',
                        type: 'region',
                        coordinates: [40.1158, 67.8422],
                        districts: [
                            { name: 'Jizzax shahri', coordinates: [40.1158, 67.8422] },
                            { name: 'Arnasoy tumani', coordinates: [40.3000, 68.5167] },
                            { name: 'Baxtiyor tumani', coordinates: [40.3333, 67.8000] },
                            { name: 'Do\'stlik tumani', coordinates: [40.3833, 68.0833] },
                            { name: 'Forish tumani', coordinates: [40.1333, 67.9667] },
                            { name: 'G\'allaorol tumani', coordinates: [40.0333, 68.0500] },
                            { name: 'Mirzacho\'l tumani', coordinates: [40.6167, 68.2833] },
                            { name: 'Paxtakor tumani', coordinates: [40.3000, 67.4333] },
                            { name: 'Yangiobod tumani', coordinates: [39.9667, 67.6167] },
                            { name: 'Zafarobod tumani', coordinates: [40.0167, 67.7167] },
                            { name: 'Zarbdor tumani', coordinates: [40.1833, 68.1167] },
                            { name: 'Zomin tumani', coordinates: [39.9667, 68.4000] }
                        ]
                    },
                    {
                        id: 'sirdarya',
                        name: 'Sirdaryo viloyati',
                        type: 'region',
                        coordinates: [40.8375, 68.6706],
                        districts: [
                            { name: 'Guliston shahri', coordinates: [40.4833, 68.7833] },
                            { name: 'Yangiyer shahri', coordinates: [40.2667, 68.8167] },
                            { name: 'Shirin shahri', coordinates: [40.1167, 68.1167] },
                            { name: 'Boyovut tumani', coordinates: [40.8167, 68.8000] },
                            { name: 'Guliston tumani', coordinates: [40.4333, 68.6167] },
                            { name: 'Mirzaobod tumani', coordinates: [40.6333, 68.6833] },
                            { name: 'Oqoltin tumani', coordinates: [40.8500, 68.4667] },
                            { name: 'Sardoba tumani', coordinates: [40.8667, 68.3000] },
                            { name: 'Sayxunobod tumani', coordinates: [40.7500, 68.9000] },
                            { name: 'Xovos tumani', coordinates: [40.3167, 68.9833] }
                        ]
                    },
                    {
                        id: 'karakalpakstan',
                        name: 'Qoraqalpog\'iston Respublikasi',
                        type: 'republic',
                        coordinates: [43.8041, 59.4453],
                        districts: [
                            { name: 'Nukus shahri', coordinates: [42.4531, 59.6103] },
                            { name: 'Amudaryo tumani', coordinates: [42.3667, 60.5833] },
                            { name: 'Beruniy tumani', coordinates: [41.6833, 60.7500] },
                            { name: 'Bo\'zatov tumani', coordinates: [42.8333, 58.3167] },
                            { name: 'Chimboy tumani', coordinates: [42.9167, 59.7833] },
                            { name: 'Ellikqala tumani', coordinates: [42.1167, 60.0000] },
                            { name: 'Kegeyli tumani', coordinates: [42.4000, 58.6167] },
                            { name: 'Qanliko\'l tumani', coordinates: [43.4000, 58.7167] },
                            { name: 'Qorao\'zak tumani', coordinates: [43.4333, 58.9000] },
                            { name: 'Qo\'ng\'irot tumani', coordinates: [43.0667, 58.9167] },
                            { name: 'Mo\'ynoq tumani', coordinates: [43.7500, 59.0333] },
                            { name: 'Nukus tumani', coordinates: [42.3833, 59.4833] },
                            { name: 'Shumanay tumani', coordinates: [42.1833, 59.8167] },
                            { name: 'Taxtako\'pir tumani', coordinates: [41.9333, 60.3000] },
                            { name: 'To\'rtko\'l tumani', coordinates: [41.5500, 60.3833] },
                            { name: 'Xo\'jayli tumani', coordinates: [42.3833, 59.9167] }
                        ]
                    }
                ];

                this.processLocationsFromData();
            }

            processLocationsFromAPI() {
                this.locations = [];
                let totalDistricts = 0;

                this.allLocations.forEach(region => {
                    // Add region/city itself
                    this.locations.push({
                        id: this.locations.length + 1,
                        name: region.name,
                        lat: region.coordinates[0],
                        lng: region.coordinates[1],
                        type: region.type,
                        parentRegion: null
                    });

                    // Add districts
                    if (region.districts) {
                        region.districts.forEach(district => {
                            this.locations.push({
                                id: this.locations.length + 1,
                                name: district.name,
                                lat: district.coordinates[0],
                                lng: district.coordinates[1],
                                type: 'district',
                                parentRegion: region.name
                            });
                            totalDistricts++;
                        });
                    }
                });

                this.updateStats(this.allLocations.length, totalDistricts);
                this.renderLocationsList();
                this.addMapMarkers();
            }

            processLocationsFromData() {
                this.locations = [];
                let totalDistricts = 0;

                this.allLocations.forEach(region => {
                    // Add region/city itself
                    this.locations.push({
                        id: this.locations.length + 1,
                        name: region.name,
                        lat: region.coordinates[0],
                        lng: region.coordinates[1],
                        type: region.type,
                        parentRegion: null
                    });

                    // Add districts
                    if (region.districts) {
                        region.districts.forEach(district => {
                            this.locations.push({
                                id: this.locations.length + 1,
                                name: district.name,
                                lat: district.coordinates[0],
                                lng: district.coordinates[1],
                                type: 'district',
                                parentRegion: region.name
                            });
                            totalDistricts++;
                        });
                    }
                });

                this.updateStats(this.allLocations.length, totalDistricts);
                this.renderLocationsList();
                this.addMapMarkers();
            }

            updateStats(regions, districts) {
                const totalRegionsEl = document.getElementById('totalRegions');
                const totalDistrictsEl = document.getElementById('totalDistricts');

                if (totalRegionsEl) totalRegionsEl.textContent = regions;
                if (totalDistrictsEl) totalDistrictsEl.textContent = districts;
            }

            renderLocationsList() {
                const container = document.getElementById('locationsList');
                if (!container) return;

                // Group by parent regions
                const regions = {};
                this.locations.forEach(location => {
                    if (!location.parentRegion) {
                        // This is a region/city itself
                        if (!regions[location.name]) {
                            regions[location.name] = {
                                region: location,
                                districts: []
                            };
                        }
                    } else {
                        // This is a district
                        if (!regions[location.parentRegion]) {
                            regions[location.parentRegion] = {
                                region: null,
                                districts: []
                            };
                        }
                        regions[location.parentRegion].districts.push(location);
                    }
                });

                const locationsHtml = Object.entries(regions).map(([regionName, data], index) => {
                    const region = data.region;
                    const districts = data.districts;

                    if (!region) return ''; // Skip if no region data

                    const typeIcon = region.type === 'city' ? 'fas fa-city' :
                                   region.type === 'republic' ? 'fas fa-flag' : 'fas fa-map';
                    const typeColor = region.type === 'city' ? '#10b981' :
                                    region.type === 'republic' ? '#8b5cf6' : '#3b82f6';
                    const safeRegionId = `region_${index}`;

                    return `
                        <div class="region-group" style="margin-bottom: 15px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                            <!-- Region Header -->
                            <div class="region-header" onclick="dashboard.toggleRegion('${safeRegionId}')" style="padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)'">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="${typeIcon}" style="color: ${typeColor}; font-size: 16px;"></i>
                                    <div>
                                        <div style="font-weight: 600; color: #1e293b; font-size: 16px;">${region.name}</div>
                                        <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${districts.length} ta joy</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <button onclick="event.stopPropagation(); dashboard.focusLocation(${region.lat}, ${region.lng}, '${region.name}')" style="padding: 6px 12px; background: ${typeColor}; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                        <i class="fas fa-crosshairs"></i> Ko'rish
                                    </button>
                                    <i class="fas fa-chevron-down region-chevron" id="chevron-${safeRegionId}" style="color: #64748b; transition: transform 0.3s ease;"></i>
                                </div>
                            </div>
                            <!-- Districts List -->
                            <div class="districts-list" id="districts-${safeRegionId}" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #ffffff;">
                                ${districts.map(district => `
                                    <div onclick="dashboard.focusLocation(${district.lat}, ${district.lng}, '${district.name}')" style="padding: 12px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#ffffff'">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-map-pin" style="color: #64748b; font-size: 12px;"></i>
                                            <span style="color: #374151; font-size: 14px;">${district.name}</span>
                                        </div>
                                        <small style="color: #94a3b8; font-size: 11px;">${district.lat.toFixed(3)}, ${district.lng.toFixed(3)}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = locationsHtml;
            }

            addMapMarkers() {
                if (!window.locationsMap) return;

                // Clear existing markers
                if (window.locationMarkers) {
                    window.locationMarkers.forEach(marker => window.locationsMap.removeLayer(marker));
                }
                window.locationMarkers = [];

                // Add markers for each location
                this.locations.forEach(location => {
                    const marker = L.marker([location.lat, location.lng])
                        .addTo(window.locationsMap)
                        .bindPopup(`<b>${location.name}</b>`);

                    window.locationMarkers.push(marker);
                });
            }

            focusLocation(lat, lng, name) {
                console.log(`üìç Focusing on ${name} (${lat}, ${lng})`);

                // Update both Google and Yandex maps
                this.updateMapCenter(`${lat},${lng}`);

                // Show notification
                this.showLocationToast(name, lat, lng);
            }

            showLocationToast(name, lat, lng) {
                // Create toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
                    z-index: 10000;
                    font-weight: 600;
                    font-size: 14px;
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                `;

                toast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-map-pin" style="color: #fbbf24;"></i>
                        <div>
                            <div style="font-weight: 700;">${name}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</div>
                        </div>
                    </div>
                `;

                document.body.appendChild(toast);

                // Remove after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            filterLocations(searchTerm) {
                this.renderLocationsList();
            }

            // Yangi funksiyalar qo'shish
            toggleRegion(regionId) {
                const districtsList = document.getElementById(`districts-${regionId}`);
                const chevron = document.getElementById(`chevron-${regionId}`);

                if (districtsList && chevron) {
                    const isExpanded = districtsList.style.maxHeight && districtsList.style.maxHeight !== '0px';

                    if (isExpanded) {
                        districtsList.style.maxHeight = '0px';
                        chevron.style.transform = 'rotate(0deg)';
                    } else {
                        districtsList.style.maxHeight = `${districtsList.scrollHeight}px`;
                        chevron.style.transform = 'rotate(180deg)';
                    }
                } else {
                    console.log('‚ùå Elements not found:', `districts-${regionId}`, `chevron-${regionId}`);
                }
            }

            searchLocations(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                const regionGroups = document.querySelectorAll('.region-group');

                regionGroups.forEach(group => {
                    const regionName = group.querySelector('.region-header div div').textContent.toLowerCase();
                    const districts = group.querySelectorAll('.districts-list > div');

                    let hasMatch = regionName.includes(term);
                    let visibleDistricts = 0;

                    districts.forEach(district => {
                        const districtName = district.querySelector('span').textContent.toLowerCase();
                        if (districtName.includes(term) || term === '') {
                            district.style.display = 'flex';
                            visibleDistricts++;
                            hasMatch = true;
                        } else {
                            district.style.display = 'none';
                        }
                    });

                    if (hasMatch || term === '') {
                        group.style.display = 'block';
                        // Agar qidiruv natijasi bo'lsa, viloyatni ochib ko'rsatish
                        if (term && visibleDistricts > 0) {
                            const districtsList = group.querySelector('.districts-list');
                            const chevron = group.querySelector('.region-chevron');
                            if (districtsList && chevron) {
                                districtsList.style.maxHeight = `${districtsList.scrollHeight}px`;
                                chevron.style.transform = 'rotate(180deg)';
                            }
                        }
                    } else {
                        group.style.display = 'none';
                    }
                });
            }

            // Map switching functions
            switchToOSMMap() {
                const osmMap = document.getElementById('osmMap');
                const googleMap = document.getElementById('googleMap');

                if (osmMap && googleMap) {
                    osmMap.style.display = 'block';
                    googleMap.style.display = 'none';
                    console.log('üó∫Ô∏è Switched to OpenStreetMap');
                }
            }

            switchToGoogleMap() {
                const osmMap = document.getElementById('osmMap');
                const googleMap = document.getElementById('googleMap');

                if (osmMap && googleMap) {
                    osmMap.style.display = 'none';
                    googleMap.style.display = 'block';
                    console.log('üó∫Ô∏è Switched to Google Maps');
                }
            }

            centerMap() {
                // Center to Uzbekistan coordinates
                const uzbekistanCoords = "41.2995,69.2401";
                this.updateMapCenter(uzbekistanCoords);
            }

            updateMapCenter(coords) {
                const [lat, lng] = coords.split(',');
                const osmMap = document.getElementById('osmMap');
                const googleMap = document.getElementById('googleMap');

                console.log(`üó∫Ô∏è Updating maps to: ${lat}, ${lng}`);

                // Update OpenStreetMap
                if (osmMap) {
                    const bbox = this.calculateBbox(parseFloat(lat), parseFloat(lng), 0.1);
                    const newOSMSrc = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lng}`;
                    osmMap.src = newOSMSrc;
                    console.log('‚úÖ OpenStreetMap updated');
                }

                // Update Google Maps
                if (googleMap) {
                    const newGoogleSrc = `https://maps.google.com/maps?q=${lat},${lng}&hl=en&z=12&output=embed`;
                    googleMap.src = newGoogleSrc;
                    console.log('‚úÖ Google Map updated');
                }
            }

            calculateBbox(lat, lng, delta) {
                const minLon = lng - delta;
                const minLat = lat - delta;
                const maxLon = lng + delta;
                const maxLat = lat + delta;
                return `${minLon},${minLat},${maxLon},${maxLat}`;
            }

            toggleMapStyle() {
                // Toggle between OSM and Google
                const osmMap = document.getElementById('osmMap');
                if (osmMap && osmMap.style.display !== 'none') {
                    this.switchToGoogleMap();
                } else {
                    this.switchToOSMMap();
                }
            }

            showAddLocationModal() {
                document.getElementById('addLocationModal').style.display = 'block';
            }

            closeAddLocationModal() {
                document.getElementById('addLocationModal').style.display = 'none';
                document.getElementById('addLocationForm').reset();
            }

            // New Enterprise Module Functions
            openCommissionModal() {
                const modal = document.createElement('div');
                modal.id = 'commissionModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: #1e293b;">üí∞ Komissiya Boshqaruvi</h2>
                            <button onclick="this.closest('#commissionModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">√ó</button>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #334155; margin-bottom: 1rem;">Joriy Komissiya Sozlamalari</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #475569;">Standart komissiya</div>
                                    <div style="font-size: 1.5rem; color: #3b82f6; font-weight: 700;">15%</div>
                                </div>
                                <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #475569;">Premium komissiya</div>
                                    <div style="font-size: 1.5rem; color: #10b981; font-weight: 700;">12%</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #334155; margin-bottom: 1rem;">Komissiya O'zgartirish</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Standart (%)</label>
                                    <input type="number" id="standardRate" value="15" min="0" max="50" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Premium (%)</label>
                                    <input type="number" id="premiumRate" value="12" min="0" max="50" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #334155; margin-bottom: 1rem;">Haydovchilar Hisoboti</h3>
                            <div id="driverCommissionList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                                ${this.generateDriverCommissionList()}
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="this.closest('#commissionModal').remove()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Yopish</button>
                            <button onclick="dashboard.updateCommissionRates()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Saqlash</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            generateDriverCommissionList() {
                const drivers = this.apiData.drivers || [];
                if (drivers.length === 0) {
                    return '<div style="padding: 1rem; text-align: center; color: #64748b;">Haydovchilar topilmadi</div>';
                }

                return drivers.map(driver => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9;">
                        <div>
                            <div style="font-weight: 600; color: #1e293b;">${driver.name || driver.first_name || 'Noma\'lum'}</div>
                            <div style="font-size: 0.875rem; color: #64748b;">ID: ${driver.id}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #059669;">${(driver.balance || 0).toLocaleString()} so'm</div>
                            <div style="font-size: 0.875rem; color: #64748b;">15% komissiya</div>
                        </div>
                    </div>
                `).join('');
            }

            updateCommissionRates() {
                const standardRate = document.getElementById('standardRate').value;
                const premiumRate = document.getElementById('premiumRate').value;

                // Simulate API call
                this.showToast('Komissiya sozlamalari yangilandi!', 'success');
                document.getElementById('commissionModal').remove();
            }

            openDriverPayments() {
                const modal = document.createElement('div');
                modal.id = 'driverPaymentsModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: #1e293b;">üöó Haydovchi To'lovlari</h2>
                            <button onclick="this.closest('#driverPaymentsModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">√ó</button>
                        </div>

                        ${this.generateDriverPaymentsList()}

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="this.closest('#driverPaymentsModal').remove()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Yopish</button>
                            <button onclick="dashboard.exportDriverPayments()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Excel ga eksport</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            generateDriverPaymentsList() {
                const drivers = this.apiData.drivers || [];
                if (drivers.length === 0) {
                    return '<div style="padding: 2rem; text-align: center; color: #64748b;">Haydovchilar topilmadi</div>';
                }

                const totalBalance = drivers.reduce((sum, driver) => sum + (driver.balance || 0), 0);

                return `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="padding: 1rem; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.875rem; opacity: 0.9;">Jami balans</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${totalBalance.toLocaleString()} so'm</div>
                            </div>
                            <div style="padding: 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.875rem; opacity: 0.9;">Faol haydovchilar</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${drivers.length} ta</div>
                            </div>
                        </div>
                    </div>

                    <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                        <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <h3 style="margin: 0; color: #1e293b;">Haydovchilar Ro'yxati</h3>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${drivers.map(driver => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #f1f5f9;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                            ${(driver.name || driver.first_name || 'N')[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: #1e293b;">${driver.name || driver.first_name || 'Noma\'lum'}</div>
                                            <div style="font-size: 0.875rem; color: #64748b;">ID: ${driver.id} ‚Ä¢ Tel: ${driver.phone || 'N/A'}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: #059669; font-size: 1.1rem;">${(driver.balance || 0).toLocaleString()} so'm</div>
                                        <button onclick="dashboard.processDriverPayment('${driver.id}')" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; margin-top: 0.25rem;">
                                            Pul berish
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            processDriverPayment(driverId) {
                const amount = prompt('To\'lov summasini kiriting (so\'m):');
                if (amount && !isNaN(amount) && amount > 0) {
                    // Simulate payment processing
                    this.showToast(`Haydovchiga ${parseInt(amount).toLocaleString()} so'm to'lov qilindi!`, 'success');
                    // Refresh the modal
                    document.getElementById('driverPaymentsModal').remove();
                    this.openDriverPayments();
                }
            }

            exportDriverPayments() {
                this.showToast('Excel fayl yuklab olinmoqda...', 'info');
                // Simulate export
                setTimeout(() => {
                    this.showToast('Haydovchilar to\'lovlari Excel faylga eksport qilindi!', 'success');
                }, 1500);
            }

            openSettingsModal() {
                const modal = document.createElement('div');
                modal.id = 'settingsModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: #1e293b;">‚öôÔ∏è Tizim Sozlamalari</h2>
                            <button onclick="this.closest('#settingsModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">√ó</button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h3 style="color: #334155; margin-bottom: 1rem;">Bot Sozlamalari</h3>
                                <div style="space-y: 1rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Bot nomi</label>
                                        <input type="text" value="@yoldauz_yukbot" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Avtomatik javob</label>
                                        <select style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                            <option>Yoqilgan</option>
                                            <option>O'chirilgan</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 style="color: #334155; margin-bottom: 1rem;">Narx Sozlamalari</h3>
                                <div style="space-y: 1rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Minimal tarif (so'm/km)</label>
                                        <input type="number" value="2000" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Qo'shimcha xizmat (%)</label>
                                        <input type="number" value="10" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                            <h3 style="color: #334155; margin-bottom: 1rem;">Tizim Ma'lumotlari</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #475569;">Versiya</div>
                                    <div style="color: #3b82f6; font-weight: 600;">v2.0.0 Enterprise</div>
                                </div>
                                <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #475569;">Oxirgi yangilanish</div>
                                    <div style="color: #10b981; font-weight: 600;">${new Date().toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                            <button onclick="this.closest('#settingsModal').remove()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Bekor qilish</button>
                            <button onclick="dashboard.saveSettings()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Saqlash</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            saveSettings() {
                this.showToast('Sozlamalar saqlandi!', 'success');
                document.getElementById('settingsModal').remove();
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const colors = {
                    success: '#10b981',
                    error: '#ef4444',
                    info: '#3b82f6',
                    warning: '#f59e0b'
                };

                toast.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10001;
                    background: ${colors[type]}; color: white; padding: 1rem 1.5rem;
                    border-radius: 8px; font-weight: 600; max-width: 350px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                    animation: slideInRight 0.3s ease-out;
                `;

                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            addNewLocation() {
                // Modal orqali qo'shish
                this.showAddLocationModal();

                // Form submit event listener
                const form = document.getElementById('addLocationForm');
                form.onsubmit = (e) => {
                    e.preventDefault();

                    const name = document.getElementById('locationName').value;
                    const lat = parseFloat(document.getElementById('locationLat').value);
                    const lng = parseFloat(document.getElementById('locationLng').value);
                    const type = document.getElementById('locationType').value;

                    if (!name || isNaN(lat) || isNaN(lng)) {
                        alert('Barcha maydonlarni to\'ldiring!');
                        return;
                    }

                    const newLocation = {
                        id: this.locations.length + 1,
                        name: name,
                        lat: lat,
                        lng: lng,
                        type: type,
                        parentRegion: null
                    };

                    this.locations.push(newLocation);
                    this.renderLocationsList();
                    this.addMapMarkers();
                    this.closeAddLocationModal();

                    // Focus to new location
                    this.focusLocation(lat, lng, name);
                };
            }

            // Modal events
            setupLocationModalEvents() {
                // Click outside modal to close
                document.getElementById('addLocationModal').addEventListener('click', (e) => {
                    if (e.target.id === 'addLocationModal') {
                        this.closeAddLocationModal();
                    }
                });

                // ESC key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAddLocationModal();
                    }
                });
            }

            renderDispatchers() {
                const dispatchers = this.apiData.dispatchers || [];
                console.log('üìä Rendering dispatchers:', dispatchers);

                if (dispatchers.length === 0) {
                    return `
                        <div class="content-card">
                            <div class="content-header">
                                <h2 class="content-title">Dispecherlar boshqaruvi</h2>
                            </div>
                            <div style="padding: 2rem; text-align: center;">
                                <div style="width: 5rem; height: 5rem; border-radius: 1rem; background: #f3f4f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                    <i class="fas fa-headset" style="font-size: 2rem;"></i>
                                </div>
                                <h3 style="color: #374151; margin-bottom: 0.5rem;">Dispecherlar topilmadi</h3>
                                <p style="color: #6b7280;">Hali hech qanday dispecher ro'yxatdan o'tmagan</p>
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')" style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="content-card">
                        <div class="content-header">
                            <h2 class="content-title">Dispecherlar boshqaruvi</h2>
                            <div class="content-actions">
                                <button class="btn-secondary" onclick="dashboard.refreshDispatchers()">
                                    <i class="fas fa-refresh"></i>
                                    <span>Yangilash</span>
                                </button>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="color: #1f2937; margin: 0 0 0.25rem 0;">Bot'dan ro'yxatdan o'tgan dispecherlar</h4>
                                        <p style="color: #6b7280; margin: 0; font-size: 0.875rem;">Real foydalanuvchilar ma'lumotlari</p>
                                    </div>
                                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;">${dispatchers.length}</div>
                                </div>
                            </div>
                            <p style="color: #6b7280; text-align: center;">Dispecherlar ma'lumotlari yuklanmoqda...</p>
                            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCustomers() {
                const customers = this.apiData.customers || [];
                console.log('üìä Rendering customers:', customers);

                if (customers.length === 0) {
                    return `
                        <div class="content-card">
                            <div class="content-header">
                                <h2 class="content-title">Mijozlar boshqaruvi</h2>
                            </div>
                            <div style="padding: 2rem; text-align: center;">
                                <div style="width: 5rem; height: 5rem; border-radius: 1rem; background: #f3f4f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                    <i class="fas fa-users" style="font-size: 2rem;"></i>
                                </div>
                                <h3 style="color: #374151; margin-bottom: 0.5rem;">Mijozlar topilmadi</h3>
                                <p style="color: #6b7280;">Hali hech qanday mijoz ro'yxatdan o'tmagan</p>
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')" style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                            </div>
                        </div>
                    `;
                }

                const customersTable = customers.map(customer => `
                    <tr>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); color: white; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #111827;">${customer.name}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">${customer.id}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb; color: #374151;">${this.formatPhoneNumber(customer.phone)}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb; color: #374151;">${customer.company || 'Shaxsiy'}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb; color: #374151;">${customer.totalOrders || 0}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb; color: #374151;">${this.formatCurrency(customer.totalSpent || 0)}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <button
                                onclick="dashboard.showCustomerOrderHistory('${customer.id}')"
                                style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 0.625rem 1.25rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.3s ease; font-size: 0.875rem;"
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)'"
                            >
                                <i class="fas fa-history"></i>
                                Tarixi
                            </button>
                        </td>
                    </tr>
                `).join('');

                return `
                    <div class="content-card">
                        <div class="content-header">
                            <h2 class="content-title">Mijozlar ko'rish (faqat o'qish)</h2>
                            <div class="content-actions">
                                <button class="btn-secondary" onclick="dashboard.refreshCustomers()">
                                    <i class="fas fa-refresh"></i>
                                    <span>Yangilash</span>
                                </button>
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #fef3cd; color: #92400e; border-radius: 0.5rem; font-size: 0.875rem;">
                                    <i class="fas fa-lock"></i>
                                    <span>Faqat ko'rish rejimi</span>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <!-- QIDIRUV VA EXPORT PANELI -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div style="flex: 1; min-width: 300px;">
                                        <div style="position: relative;">
                                            <input
                                                type="text"
                                                id="customerSearchInput"
                                                placeholder="Mijoz ismi yoki telefon raqami bo'yicha qidirish..."
                                                style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: none; border-radius: 0.75rem; font-size: 1rem; background: rgba(255,255,255,0.95); color: #374151; box-shadow: 0 4px 15px rgba(0,0,0,0.1); outline: none; transition: all 0.3s ease;"
                                                oninput="dashboard.filterCustomers(this.value)"
                                            >
                                            <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 1rem;"></i>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                                        <button
                                            onclick="dashboard.exportCustomersToExcel()"
                                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); transition: all 0.3s ease; font-size: 0.875rem;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.5)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.4)'"
                                        >
                                            <i class="fas fa-file-excel"></i>
                                            Excel yuklab olish
                                        </button>
                                        <div style="background: rgba(255,255,255,0.2); padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: white;">
                                            <div style="font-size: 0.875rem; opacity: 0.9;">Jami mijozlar</div>
                                            <div class="customers-counter" style="font-size: 1.5rem; font-weight: 700;">${customers.length}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="overflow-x: auto;">
                                <table id="customersTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Mijoz</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Telefon</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Kompaniya</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Buyurtmalar</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Umumiy xarajat</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Buyurtmalar tarixi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customersTable}
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')">
                                    <i class="fas fa-arrow-left"></i>
                                    Bosh sahifaga qaytish
                                </button>
                                <div style="color: #6b7280; font-size: 0.875rem;">
                                    Jami: ${customers.length} ta mijoz
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderLocations() {
                return `
                    <div class="locations-container" style="height: 700px; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin: 20px 0; overflow: hidden;">
                        <!-- Locations Sidebar -->
                        <div class="locations-sidebar" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); overflow-y: auto;">
                            <div class="sidebar-header" style="margin-bottom: 20px;">
                                <h2 style="color: #1e293b; font-size: 24px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-map-marked-alt" style="color: #3b82f6;"></i>
                                    O'zbekiston Lokatsiyalari
                                </h2>
                                <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">Barcha viloyat va tumanlar</p>

                                <!-- Search -->
                                <div style="position: relative; margin-bottom: 15px;">
                                    <input type="text" id="locationSearch" placeholder="Lokatsiya qidirish..." style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; background: #f8fafc; transition: all 0.3s ease;" oninput="dashboard.searchLocations(this.value)">
                                    <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                                </div>

                                <!-- Add Location Button -->
                                <button onclick="dashboard.showAddLocationModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <i class="fas fa-plus"></i>
                                    Yangi lokatsiya qo'shish
                                </button>
                            </div>

                            <!-- Stats -->
                            <div class="location-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700;" id="totalRegions">14</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Viloyatlar</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700;" id="totalDistricts">200+</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Tumanlar</div>
                                </div>
                            </div>

                            <!-- Locations List -->
                            <div id="locationsList" class="locations-list" style="max-height: 500px; overflow-y: auto; overscroll-behavior: contain;"></div>
                        </div>

                        <!-- Map Container -->
                        <div class="map-container" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); position: relative;">
                            <div class="map-header" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="color: #1e293b; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-globe" style="color: #3b82f6;"></i>
                                    Interaktiv Xarita
                                </h3>
                                <div class="map-controls" style="display: flex; gap: 10px;">
                                    <button onclick="dashboard.centerMap()" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 12px; color: #475569; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                        <i class="fas fa-crosshairs"></i> Markazlashtirish
                                    </button>
                                    <button onclick="dashboard.toggleMapStyle()" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 12px; color: #475569; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                        <i class="fas fa-layer-group"></i> Uslub
                                    </button>
                                </div>
                            </div>
                            <!-- OpenStreetMap Embed (Primary) -->
                            <iframe id="osmMap"
                                src="https://www.openstreetmap.org/export/embed.html?bbox=55.99762,35.14073,73.05526,45.57609&layer=mapnik&marker=41.2995,69.2401"
                                style="width: 100%; height: 600px; border: none; border-radius: 12px;"
                                allowfullscreen="">
                            </iframe>

                            <!-- Google Maps (Alternative) -->
                            <iframe id="googleMap" style="display: none; width: 100%; height: 600px; border: none; border-radius: 12px;"
                                src="https://maps.google.com/maps?q=41.2995,69.2401&hl=en&z=8&output=embed"
                                allowfullscreen="">
                            </iframe>

                            <!-- Map Controls -->
                            <div class="map-controls-overlay" style="position: absolute; top: 80px; right: 30px; z-index: 10; display: flex; flex-direction: column; gap: 10px;">
                                <button onclick="dashboard.switchToOSMMap()" style="padding: 10px; background: #7dd3fc; color: #1e293b; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                    <i class="fas fa-map"></i> OSM
                                </button>
                                <button onclick="dashboard.switchToGoogleMap()" style="padding: 10px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                    <i class="fab fa-google"></i> Google
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Add Location Modal -->
                    <div id="addLocationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; backdrop-filter: blur(4px);">
                        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 500px; width: 90%;">
                            <h3 style="margin-bottom: 20px; color: #1e293b; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-map-pin" style="color: #3b82f6;"></i>
                                Yangi Lokatsiya Qo'shish
                            </h3>
                            <form id="addLocationForm">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Nomi</label>
                                    <input type="text" id="locationName" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Masalan: Toshkent shahri">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Latitude</label>
                                        <input type="number" id="locationLat" required step="0.0001" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="41.2995">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Longitude</label>
                                        <input type="number" id="locationLng" required step="0.0001" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="69.2401">
                                    </div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Turi</label>
                                    <select id="locationType" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="city">Shahar</option>
                                        <option value="region">Viloyat</option>
                                        <option value="district">Tuman</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button type="button" onclick="dashboard.closeAddLocationModal()" style="padding: 12px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Bekor qilish</button>
                                    <button type="submit" style="padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Qo'shish</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderComingSoon(page) {
                const pageNames = {
                    finance: 'Moliyaviy hisobotlar',
                    history: 'Buyurtmalar tarixi',
                    analytics: 'Analitika',
                    employees: 'Xodimlar',
                    roles: 'Rollar va huquqlar',
                    support: 'Qo\'llab-quvvatlash',
                    settings: 'Sozlamalar'
                };

                return `
                    <div class="content-card" style="padding: 3rem; text-align: center;">
                        <div style="width: 5rem; height: 5rem; border-radius: 1rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                            <i class="fas fa-tools" style="font-size: 2rem;"></i>
                        </div>
                        <h2 style="font-size: 2rem; font-weight: 700; color: #111827; margin-bottom: 1rem;">
                            ${pageNames[page] || 'Bo\'lim'}
                        </h2>
                        <p style="color: #6b7280; margin-bottom: 2rem;">
                            Bu bo'lim professional darajada ishlab chiqilmoqda...
                        </p>
                        <button class="btn-secondary" onclick="dashboard.loadPage('dashboard')">
                            <i class="fas fa-arrow-left"></i>
                            Bosh sahifaga qaytish
                        </button>
                    </div>
                `;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('uz-UZ', {
                    style: 'currency',
                    currency: 'UZS',
                    minimumFractionDigits: 0
                }).format(amount).replace('UZS', 'so\'m');
            }

            getPageDisplayName(page) {
                const pageNames = {
                    dashboard: 'Bosh sahifa',
                    orders: 'Buyurtmalar nazorati',
                    drivers: 'Haydovchilar',
                    dispatchers: 'Dispecherlar',
                    customers: 'Mijozlar',
                    finance: 'Moliyaviy hisobotlar',
                    history: 'Buyurtmalar tarixi',
                    analytics: 'Analitika',
                    employees: 'Xodimlar',
                    roles: 'Rollar va huquqlar',
                    support: 'Qo\'llab-quvvatlash',
                    settings: 'Sozlamalar'
                };
                return pageNames[page] || page;
            }

            // Action methods
            async refreshActivity() {
                console.log('üîÑ Refreshing activity...');
                await this.loadApiData();
                this.loadPage('dashboard');
                this.showNotification('Ma\'lumotlar yangilandi', 'success');
            }

            async refreshOrders() {
                console.log('üîÑ Refreshing orders...');
                await this.loadApiData();
                this.loadPage('orders');
                this.showNotification('Buyurtmalar yangilandi', 'success');
            }

            async refreshDrivers() {
                console.log('üîÑ Refreshing drivers...');
                await this.loadApiData();
                this.loadPage('drivers');
                this.showNotification('Haydovchilar ma\'lumotlari yangilandi', 'success');
            }

            async refreshDispatchers() {
                console.log('üîÑ Refreshing dispatchers...');
                await this.loadApiData();
                this.loadPage('dispatchers');
                this.showNotification('Dispecherlar ma\'lumotlari yangilandi', 'success');
            }

            async refreshCustomers() {
                console.log('üîÑ Refreshing customers...');
                await this.loadApiData();
                this.loadPage('customers');
                this.showNotification('Mijozlar ma\'lumotlari yangilandi', 'success');
            }

            async refreshOrderHistory() {
                console.log('üîÑ Refreshing order history...');
                await this.loadApiData();
                this.loadPage('history');
                this.showNotification('Buyurtmalar tarixi yangilandi', 'success');
            }

            openModal(type) {
                console.log('üìù Opening modal:', type);
                this.showNotification('Modal oynasi qo\'shilmoqda...', 'info');
            }

            async showCustomerOrderHistory(customerId) {
                console.log('üìã Showing customer order history for:', customerId);

                try {
                    // Use the correct API endpoint that exists
                    const response = await fetch(`/api/dashboard/customers/${customerId}/history`);

                    if (!response.ok) {
                        throw new Error('API response not ok');
                    }

                    const historyData = await response.json();

                    if (!historyData.orders || historyData.orders.length === 0) {
                        this.showNotification('Bu mijozning buyurtma tarixi topilmadi', 'warning');
                        return;
                    }

                    const customer = this.apiData.customers.find(c => c.id === customerId);
                    const customerName = customer ? customer.name : 'Noma\'lum mijoz';

                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        backdrop-filter: blur(4px);
                    `;

                    // Calculate statistics for both completed and cancelled orders
                    const completedOrders = historyData.orders.filter(order => order.status === 'completed');
                    const cancelledOrders = historyData.orders.filter(order => order.status === 'cancelled');

                    modal.innerHTML = `
                        <div style="background: white; border-radius: 0.75rem; max-width: 80%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                            <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827;">
                                        <i class="fas fa-history" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                                        ${customerName} - Buyurtmalar tarixi
                                    </h3>
                                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                                </div>
                            </div>
                            <div style="padding: 1.5rem;">
                                <!-- Statistics Cards -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${historyData.orders.length}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Jami buyurtmalar</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">${completedOrders.length}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Bajarilgan</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: #fef2f2; border-radius: 0.5rem;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">${cancelledOrders.length}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Bekor qilingan</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${this.formatCurrency(historyData.stats.totalSpent)}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Jami sarflangan</div>
                                    </div>
                                </div>

                                <!-- Orders List -->
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${historyData.orders.map(order => {
                                        const statusColor = order.status === 'completed' ? '#16a34a' : '#dc2626';
                                        const statusBg = order.status === 'completed' ? '#dcfce7' : '#fee2e2';
                                        const statusText = order.status === 'completed' ? 'Bajarilgan' : 'Bekor qilingan';
                                        const statusIcon = order.status === 'completed' ? '‚úÖ' : '‚ùå';

                                        return `
                                        <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                                <div>
                                                    <div style="font-weight: 600; color: #111827;">Buyurtma #${order.id}</div>
                                                    <div style="font-size: 0.875rem; color: #6b7280;">${new Date(order.date || order.createdAt).toLocaleDateString('uz-UZ')}</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-weight: 600; color: ${statusColor}; font-size: 1.125rem;">${this.formatCurrency(order.price || order.amount)}</div>
                                                    <div style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; background: ${statusBg}; color: ${statusColor}; font-weight: 600;">
                                                        ${statusIcon} ${statusText}
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                                <div>
                                                    <strong>Qayerdan:</strong><br>
                                                    <span style="color: #6b7280;">${order.fromCity || order.pickup || 'Noma\'lum'}</span>
                                                </div>
                                                <div>
                                                    <strong>Qayerga:</strong><br>
                                                    <span style="color: #6b7280;">${order.toCity || order.destination || 'Noma\'lum'}</span>
                                                </div>
                                            </div>
                                            <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                                                <strong>Yuk turi:</strong> <span style="color: #6b7280;">${order.cargoType || 'Noma\'lum'}</span>
                                            </div>
                                            ${order.driverName ? `
                                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.875rem;">
                                                    <strong>Haydovchi:</strong> ${order.driverName}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;}).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                    modal.classList.add('modal');
                    document.body.appendChild(modal);

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });

                } catch (error) {
                    console.error('Error loading customer orders:', error);
                    this.showNotification('Buyurtma tarixi yuklanmadi', 'error');
                }
            }

            // Mijozlarni qidirish funksiyasi
            filterCustomers(searchTerm) {
                const searchLower = searchTerm.toLowerCase().trim();
                const rows = document.querySelectorAll('#customersTable tbody tr');
                let visibleCount = 0;

                rows.forEach(row => {
                    const customerName = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
                    const customerPhone = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

                    const matches = customerName.includes(searchLower) ||
                                  customerPhone.includes(searchLower) ||
                                  customerPhone.replace(/[^\d]/g, '').includes(searchLower.replace(/[^\d]/g, ''));

                    if (matches || searchTerm === '') {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Natijalar sonini yangilash
                const counterElement = document.querySelector('.customers-counter');
                if (counterElement) {
                    counterElement.textContent = searchTerm === '' ?
                        `${rows.length}` :
                        `${visibleCount} / ${rows.length}`;
                }
            }

            // Excel export funksiyasi
            async exportCustomersToExcel() {
                try {
                    this.showNotification('Excel fayl tayyorlanmoqda...', 'info');

                    const response = await fetch('/api/dashboard/customers');
                    const data = await response.json();

                    if (!data.success) {
                        this.showNotification('Ma\'lumotlarni yuklashda xatolik', 'error');
                        return;
                    }

                    const customers = data.data || [];

                    // CSV formatida ma'lumotlarni tayyorlash
                    const headers = ['ID', 'Ism', 'Telefon', 'Kompaniya', 'Qo\'shilgan sana', 'Buyurtmalar soni', 'Umumiy xarajat', 'Holat'];
                    const csvContent = [
                        headers.join(','),
                        ...customers.map(customer => [
                            customer.id || '',
                            `"${customer.name || ''}"`,
                            customer.phone || '',
                            `"${customer.company || 'Shaxsiy'}"`,
                            customer.joinDate ? new Date(customer.joinDate).toLocaleDateString('uz-UZ') : '',
                            customer.totalOrders || 0,
                            customer.totalSpent || 0,
                            customer.status || 'active'
                        ].join(','))
                    ].join('\\n');

                    // Faylni yuklab olish
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `mijozlar_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    this.showNotification('Excel fayl yuklab olindi!', 'success');
                } catch (error) {
                    console.error('Excel export error:', error);
                    this.showNotification('Excel faylni yaratishda xatolik', 'error');
                }
            }

            openNewOrderModal() {
                console.log('üìù Opening new order modal...');

                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    backdrop-filter: blur(4px);
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="color: #111827; margin: 0; font-size: 1.5rem; font-weight: 700;">Yangi buyurtma yaratish</h2>
                            <button onclick="dashboard.closeModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <form id="newOrderForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <!-- MIJOZ MA'LUMOTLARI BO'LIMI -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-user" style="color: #3b82f6;"></i>
                                    Mijoz ma'lumotlari
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                                            Mijoz telefon raqami *
                                        </label>
                                        <input type="tel" name="customerPhone" id="customerPhone" required
                                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;"
                                               placeholder="+998901234567"
                                               onkeydown="dashboard.handlePhoneKeydown(event, this.value)"
                                               oninput="dashboard.handlePhoneInput(this.value)">
                                        <small style="color: #6b7280; font-size: 0.75rem;">ENTER/TAB - qidirish va keyingi maydon</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                                            Mijoz ismi (ixtiyoriy)
                                        </label>
                                        <input type="text" name="customerName" id="customerName"
                                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;"
                                               placeholder="Mijoz ismi"
                                               onkeydown="dashboard.handleNameKeydown(event)">
                                        <small id="customerStatus" style="color: #6b7280; font-size: 0.75rem;">Telefon raqamini kiriting</small>
                                    </div>
                                </div>
                                <!-- MIJOZ STATISTIKASI -->
                                <div id="customerStats" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 0.375rem; border: 1px solid #e5e7eb;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
                                        <div>
                                            <div id="customerOrderCount" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">0</div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">Buyurtmalar</div>
                                        </div>
                                        <div>
                                            <div id="customerTotalSpent" style="font-size: 1.5rem; font-weight: 700; color: #059669;">0 so'm</div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">Jami to'langan</div>
                                        </div>
                                        <div>
                                            <button onclick="dashboard.showCustomerHistory()" style="padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer;">
                                                üìã Tarix ko'rish
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MARSHRUT BO'LIMI -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-route" style="color: #10b981;"></i>
                                    Marshrut ma'lumotlari
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="autocomplete-container">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Qayerdan</label>
                                        <input type="text" name="fromCity" id="fromCity" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;" placeholder="Masalan: Toshkent" autocomplete="off">
                                        <div class="autocomplete-suggestions" id="fromCitySuggestions"></div>
                                    </div>
                                    <div class="autocomplete-container">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Qayerga</label>
                                        <input type="text" name="toCity" id="toCity" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;" placeholder="Masalan: Samarqand" autocomplete="off">
                                        <div class="autocomplete-suggestions" id="toCitySuggestions"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Distance and Travel Time Display -->
                            <div id="routeInfo" style="display: none; background: linear-gradient(135deg, #e0f2fe, #f3e8ff); border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1rem; margin: 0.5rem 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-route" style="color: #3b82f6;"></i>
                                    <h4 style="margin: 0; color: #1e40af; font-size: 0.9rem;">Marshrut Ma'lumotlari</h4>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-road" style="color: #059669; width: 16px;"></i>
                                        <span style="color: #374151;">Masofa:</span>
                                        <strong id="routeDistance" style="color: #059669;">-- km</strong>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-clock" style="color: #d97706; width: 16px;"></i>
                                        <span style="color: #374151;">Vaqt:</span>
                                        <strong id="routeTime" style="color: #d97706;">-- soat</strong>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Yuk turi</label>
                                <input type="text" name="cargoType" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;" placeholder="Masalan: 10 tonna meva">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Yuk hajmi/vazni</label>
                                <input type="text" name="weight" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;" placeholder="Masalan: 10 tonna">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Transport turi</label>
                                <select name="truckType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;">
                                    <option value="">Transport turini tanlang</option>
                                    <option value="Yengil">Yengil transport</option>
                                    <option value="Gazel">Gazel</option>
                                    <option value="Kamaz">Kamaz</option>
                                    <option value="Fura">Fura</option>
                                    <option value="Tentli">Tentli</option>
                                    <option value="Refrigerator">Refrigerator</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Buyurtma narxi (so'm)</label>
                                <input type="number" name="price" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;" placeholder="Masalan: 2000000">
                            </div>


                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Yuklanish sanasi</label>
                                <input type="date" name="loadingDate" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Qo'shimcha ma'lumot</label>
                                <textarea name="description" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; resize: vertical;" placeholder="Qo'shimcha talablar yoki izohlar..."></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                                <button type="button" onclick="dashboard.closeModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                                    Bekor qilish
                                </button>
                                <button type="submit" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                                    <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>
                                    Buyurtma yaratish
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);
                this.currentModal = modal;

                // Form submit handler
                document.getElementById('newOrderForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createNewOrder(e.target);
                });

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal();
                    }
                });
            }

            closeModal() {
                if (this.currentModal) {
                    document.body.removeChild(this.currentModal);
                    this.currentModal = null;
                }
            }

            // Telefon input keydown handler
            async handlePhoneKeydown(event, value) {
                if (event.key === 'Enter' || event.key === 'Tab') {
                    event.preventDefault();
                    await this.searchAndFocusNext(value);
                }
            }

            // Telefon input handler
            async handlePhoneInput(value) {
                // Real-time validation
                if (value && value.length >= 9) {
                    this.searchCustomerByPhone(value);
                } else {
                    document.getElementById('customerStatus').textContent = 'Telefon raqamini to\'liq kiriting';
                    document.getElementById('customerStats').style.display = 'none';
                    this.currentCustomer = null;
                }
            }

            // Ism input keydown handler
            handleNameKeydown(event) {
                if (event.key === 'Enter' || event.key === 'Tab') {
                    event.preventDefault();
                    // Ism yozilgandan keyin fromCity'ga o'tish
                    const fromCityInput = document.getElementById('fromCity');
                    if (fromCityInput) {
                        fromCityInput.focus();
                        fromCityInput.select();
                    }
                }
            }

            // Oxirgi buyurtma ma'lumotlari bilan formani to'ldirish
            async fillFormWithLastOrder(customerPhone) {
                try {
                    console.log('üìã Loading last order for customer:', customerPhone);

                    // Mijozning oxirgi buyurtmasini olish
                    const response = await fetch('/api/dashboard/customers/orders-history');
                    const ordersHistory = await response.json();

                    // Bu mijozning buyurtmalarini topish
                    const customerOrders = ordersHistory.filter(order =>
                        order.phone === customerPhone ||
                        order.customerPhone === customerPhone
                    ).sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

                    if (customerOrders.length > 0) {
                        const lastOrder = customerOrders[0];
                        console.log('üìã Found last order:', lastOrder);

                        // Formani to'ldirish
                        if (lastOrder.fromCity || lastOrder.pickup) {
                            document.getElementById('fromCity').value = lastOrder.fromCity || lastOrder.pickup || '';
                        }
                        if (lastOrder.toCity || lastOrder.destination) {
                            document.getElementById('toCity').value = lastOrder.toCity || lastOrder.destination || '';
                        }
                        if (lastOrder.cargoType) {
                            document.getElementById('cargoType').value = lastOrder.cargoType || '';
                        }
                        if (lastOrder.truckType || lastOrder.truckInfo) {
                            document.getElementById('truckType').value = lastOrder.truckType || lastOrder.truckInfo || '';
                        }
                        if (lastOrder.weight) {
                            document.getElementById('weight').value = lastOrder.weight || '';
                        }
                        if (lastOrder.price || lastOrder.amount) {
                            document.getElementById('price').value = lastOrder.price || lastOrder.amount || '';
                        }
                        if (lastOrder.description) {
                            document.getElementById('description').value = lastOrder.description || '';
                        }
                        if (lastOrder.loadingDate) {
                            document.getElementById('loadingDate').value = lastOrder.loadingDate || '';
                        }

                        // Formani o'zgartirilishi mumkinligini ko'rsatish
                        this.showNotification('Oxirgi buyurtma ma\'lumotlari yuklandi (o\'zgartirishingiz mumkin)', 'info');

                        // Barcha inputlarni edit qilish mumkin qilish
                        const editableInputs = ['fromCity', 'toCity', 'cargoType', 'truckType', 'weight', 'price', 'description', 'loadingDate'];
                        editableInputs.forEach(inputId => {
                            const input = document.getElementById(inputId);
                            if (input) {
                                input.readOnly = false;
                                input.style.backgroundColor = '#fff';
                            }
                        });

                    } else {
                        console.log('üìã No previous orders found for customer');
                    }

                } catch (error) {
                    console.error('Error loading last order:', error);
                }
            }

            // Buyurtma formasini tozalash (yangi mijoz uchun)
            clearOrderForm() {
                const formInputs = ['fromCity', 'toCity', 'cargoType', 'truckType', 'weight', 'price', 'description', 'loadingDate'];
                formInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input && inputId !== 'loadingDate') {
                        input.value = '';
                        input.readOnly = false;
                        input.style.backgroundColor = '#fff';
                    }
                });

                // Ertangi sanani default qo'yish
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const loadingDateInput = document.getElementById('loadingDate');
                if (loadingDateInput) {
                    loadingDateInput.value = tomorrow.toISOString().split('T')[0];
                }
            }

            // Mijoz qidirish va keyingi inputga o'tish
            async searchAndFocusNext(phone) {
                if (!phone || phone.length < 9) {
                    document.getElementById('customerStatus').textContent = 'Telefon raqamini to\'liq kiriting';
                    document.getElementById('customerStats').style.display = 'none';
                    return;
                }

                await this.searchCustomerByPhone(phone);

                // Mijoz holatiga qarab keyingi inputga o'tish
                setTimeout(() => {
                    if (this.currentCustomer && this.currentCustomer.isNew) {
                        // Yangi mijoz - ism inputiga o'tish
                        const nameInput = document.getElementById('customerName');
                        if (nameInput) {
                            nameInput.focus();
                            nameInput.select();
                        }
                    } else {
                        // Mavjud mijoz - fromCity inputiga o'tish
                        const fromCityInput = document.getElementById('fromCity');
                        if (fromCityInput) {
                            fromCityInput.focus();
                            fromCityInput.select();
                        }
                    }
                }, 100); // Qisqa kechikish qidiruv tugashini kutish uchun
            }

            // Mijoz qidirish funksiyasi
            async searchCustomerByPhone(phone) {
                if (!phone || phone.length < 9) {
                    document.getElementById('customerStatus').textContent = 'Telefon raqamini to\'liq kiriting';
                    document.getElementById('customerStats').style.display = 'none';
                    return;
                }

                console.log('üîç Searching customer by phone:', phone);
                document.getElementById('customerStatus').textContent = 'Qidirilmoqda...';

                try {
                    // API orqali mijozni qidirish
                    const response = await fetch(`/api/dashboard/customers/search?phone=${encodeURIComponent(phone)}`);

                    if (response.ok) {
                        const result = await response.json();

                        if (result.found) {
                            // Mavjud mijoz
                            const customer = result.customer;
                            document.getElementById('customerName').value = customer.name || '';
                            document.getElementById('customerName').readOnly = false;
                            document.getElementById('customerStatus').textContent = `‚úÖ Mavjud mijoz (${customer.orderCount || 0} ta buyurtma)`;
                            document.getElementById('customerStatus').style.color = '#059669';

                            // Statistikani ko'rsatish
                            document.getElementById('customerOrderCount').textContent = customer.orderCount || 0;
                            document.getElementById('customerTotalSpent').textContent = this.formatCurrency(customer.totalSpent || 0);
                            document.getElementById('customerStats').style.display = 'block';

                            this.currentCustomer = customer;

                            // Oxirgi buyurtma ma'lumotlari bilan to'ldirish
                            await this.fillFormWithLastOrder(customer.phone);
                        } else {
                            // Yangi mijoz
                            document.getElementById('customerName').value = '';
                            document.getElementById('customerName').readOnly = false;
                            document.getElementById('customerName').placeholder = 'Yangi mijoz ismi kiriting';
                            document.getElementById('customerStatus').textContent = 'üÜï Yangi mijoz - ismini kiriting';
                            document.getElementById('customerStatus').style.color = '#3b82f6';
                            document.getElementById('customerStats').style.display = 'none';

                            this.currentCustomer = { phone: phone, isNew: true };

                            // Yangi mijoz uchun formani tozalash
                            this.clearOrderForm();
                        }
                    } else {
                        throw new Error('API xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Customer search error:', error);
                    document.getElementById('customerStatus').textContent = '‚ùå Qidirishda xatolik yuz berdi';
                    document.getElementById('customerStatus').style.color = '#ef4444';
                    document.getElementById('customerStats').style.display = 'none';
                }
            }

            // Mijoz tarixini ko'rsatish
            async showCustomerHistory() {
                if (!this.currentCustomer || this.currentCustomer.isNew) {
                    this.showNotification('Yangi mijoz uchun tarix mavjud emas', 'info');
                    return;
                }

                try {
                    const response = await fetch(`/api/dashboard/customers/${this.currentCustomer.id}/history`);
                    if (!response.ok) {
                        throw new Error('API response not ok');
                    }

                    const historyData = await response.json();

                    if (!historyData.orders || historyData.orders.length === 0) {
                        this.showNotification('Bu mijozning buyurtma tarixi topilmadi', 'warning');
                        return;
                    }

                    // Show customer order history modal
                    this.showCustomerOrderHistoryModal(historyData, this.currentCustomer.name || 'Mijoz');
                } catch (error) {
                    console.error('‚ùå History fetch error:', error);
                    this.showNotification('Tarixni yuklashda xatolik', 'error');
                }
            }

            // Customer order history modal (for order form)
            showCustomerOrderHistoryModal(historyData, customerName) {
                // Calculate statistics for both completed and cancelled orders
                const completedOrders = historyData.orders.filter(order => order.status === 'completed');
                const cancelledOrders = historyData.orders.filter(order => order.status === 'cancelled');

                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    backdrop-filter: blur(4px);
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 0.75rem; max-width: 80%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827;">
                                    <i class="fas fa-history" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                                    ${customerName} - Buyurtmalar tarixi
                                </h3>
                                <button onclick="this.closest('div').style.display='none'; this.closest('div').remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <!-- Statistics Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${historyData.orders.length}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Jami buyurtmalar</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">${completedOrders.length}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Bajarilgan</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #fef2f2; border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">${cancelledOrders.length}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Bekor qilingan</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${this.formatCurrency(historyData.stats.totalSpent)}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Jami sarflangan</div>
                                </div>
                            </div>

                            <!-- Orders List -->
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${historyData.orders.map(order => {
                                    const statusColor = order.status === 'completed' ? '#16a34a' : '#dc2626';
                                    const statusBg = order.status === 'completed' ? '#dcfce7' : '#fee2e2';
                                    const statusText = order.status === 'completed' ? 'Bajarilgan' : 'Bekor qilingan';
                                    const statusIcon = order.status === 'completed' ? '‚úÖ' : '‚ùå';

                                    return `
                                    <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                            <div>
                                                <div style="font-weight: 600; color: #111827;">Buyurtma #${order.id}</div>
                                                <div style="font-size: 0.875rem; color: #6b7280;">${new Date(order.date || order.createdAt).toLocaleDateString('uz-UZ')}</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-weight: 600; color: ${statusColor}; font-size: 1.125rem;">${this.formatCurrency(order.price || order.amount)}</div>
                                                <div style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; background: ${statusBg}; color: ${statusColor}; font-weight: 600;">
                                                    ${statusIcon} ${statusText}
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                            <div>
                                                <strong>Qayerdan:</strong><br>
                                                <span style="color: #6b7280;">${order.fromCity || order.pickup || 'Noma\'lum'}</span>
                                            </div>
                                            <div>
                                                <strong>Qayerga:</strong><br>
                                                <span style="color: #6b7280;">${order.toCity || order.destination || 'Noma\'lum'}</span>
                                            </div>
                                        </div>
                                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                                            <strong>Yuk turi:</strong> <span style="color: #6b7280;">${order.cargoType || 'Noma\'lum'}</span>
                                        </div>
                                        ${order.driverName ? `
                                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.875rem;">
                                                <strong>Haydovchi:</strong> ${order.driverName}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;}).join('')}
                            </div>
                        </div>
                    </div>
                `;

                modal.classList.add('modal');
                document.body.appendChild(modal);

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // Mijoz tarix modali (eski format - o'chirish kerak)
            showCustomerHistoryModal(history) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0, 0, 0, 0.5); display: flex; align-items: center;
                    justify-content: center; z-index: 1001; backdrop-filter: blur(4px);
                `;

                const historyTable = history.orders.map(order => `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 0.75rem;">${order.date}</td>
                        <td style="padding: 0.75rem;">${order.route}</td>
                        <td style="padding: 0.75rem;">${order.cargoType}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #059669;">${this.formatCurrency(order.amount)}</td>
                        <td style="padding: 0.75rem;">
                            <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; background: ${order.status === 'completed' ? '#d1fae5' : '#fef3c7'}; color: ${order.status === 'completed' ? '#065f46' : '#92400e'};">
                                ${order.status === 'completed' ? 'Bajarildi' : 'Bekor qilindi'}
                            </span>
                        </td>
                    </tr>
                `).join('');

                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: #111827;">üìã ${this.currentCustomer.name} - Buyurtmalar tarixi</h2>
                            <button onclick="this.closest('div').remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${history.stats.totalOrders}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Jami buyurtmalar</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${this.formatCurrency(history.stats.totalSpent)}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Jami to'langan</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${history.stats.completedOrders}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Bajarilgan</div>
                            </div>
                        </div>

                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden;">
                                <thead>
                                    <tr style="background: #f9fafb;">
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Sana</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Marshrut</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Yuk turi</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Summa</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Holat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyTable}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            async createNewOrder(form) {
                console.log('üöÄ Creating new order...');

                const formData = new FormData(form);

                // Mijoz ma'lumotlarini tekshirish
                const customerPhone = formData.get('customerPhone');
                const customerName = formData.get('customerName');

                if (!customerPhone) {
                    this.showNotification('Mijoz telefon raqami kiritilmagan!', 'error');
                    return;
                }

                const orderData = {
                    // Mijoz ma'lumotlari
                    customerPhone: customerPhone,
                    customerName: customerName || '',
                    customer: customerName || customerPhone, // Backward compatibility
                    phone: customerPhone, // Backward compatibility

                    // Marshrut ma'lumotlari
                    fromCity: formData.get('fromCity'),
                    toCity: formData.get('toCity'),
                    route: `${formData.get('fromCity')} ‚Üí ${formData.get('toCity')}`,

                    // Yuk ma'lumotlari
                    cargoType: formData.get('cargoType'),
                    weight: formData.get('weight'),
                    truckType: formData.get('truckType'),

                    // To'lov va vaqt
                    price: parseInt(formData.get('price')) || 0,
                    amount: parseInt(formData.get('price')) || 0, // Backward compatibility
                    loadingDate: formData.get('loadingDate'),

                    // Qo'shimcha
                    description: formData.get('description'),
                    adminCreated: true,
                    source: 'Dashboard',
                    createdBy: 'Dashboard Admin',
                    status: 'active',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString()
                };

                // Yangi mijoz bo'lsa, mijozlar bazasiga qo'shish
                if (this.currentCustomer && this.currentCustomer.isNew && customerName) {
                    orderData.isNewCustomer = true;
                    orderData.customerData = {
                        phone: customerPhone,
                        name: customerName,
                        joinDate: new Date().toISOString(),
                        status: 'active'
                    };
                }

                console.log('üìù Order data:', orderData);

                try {
                    // Create loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Yaratilmoqda...';
                    submitBtn.disabled = true;

                    // Yangi mijoz bo'lsa, avval mijozni saqlash
                    if (this.currentCustomer && this.currentCustomer.isNew && customerName) {
                        console.log('üíæ Saving new customer...');
                        const customerResponse = await fetch('/api/dashboard/customers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                phone: customerPhone,
                                name: customerName
                            })
                        });

                        if (customerResponse.ok) {
                            const customerResult = await customerResponse.json();
                            console.log('‚úÖ Customer saved:', customerResult);
                        } else {
                            console.warn('‚ö†Ô∏è Customer save failed, but continuing with order...');
                        }
                    }

                    // Buyurtma yaratish
                    console.log('üöÄ Sending order to API:', orderData);
                    const response = await fetch('/api/dashboard/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(orderData)
                    });
                    console.log('üì° API Response status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Order created successfully:', result);

                        this.showNotification('Buyurtma muvaffaqiyatli yaratildi! Haydovchilarga yuborilmoqda...', 'success');
                        this.closeModal();

                        // Refresh orders list
                        await this.loadApiData();
                        this.loadPage('orders');

                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå API Error response:', errorText);
                        throw new Error(`Server xatosi: ${response.status} - ${errorText}`);
                    }

                } catch (error) {
                    console.error('‚ùå Error creating order:', error);
                    this.showNotification('Buyurtma yaratishda xatolik yuz berdi. Iltimos qaytadan urinib ko\'ring.', 'error');

                    // Restore button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }

            viewOrderDetails(orderId) {
                console.log('üëÅÔ∏è Viewing order details:', orderId);
                this.showNotification(`Buyurtma ${orderId} tafsilotlari ko'rsatilmoqda...`, 'info');
            }

            editOrder(orderId) {
                console.log('‚úèÔ∏è Editing order:', orderId);
                this.showNotification(`Buyurtma ${orderId} tahrirlash oynasi ochilmoqda...`, 'info');
            }

            showNotification(message, type = 'info') {
                console.log('üîî Notification:', message);
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    padding: 1rem 1.5rem;
                    border-radius: 0.5rem;
                    color: white;
                    font-weight: 500;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            showNotifications() {
                this.showNotification('Bildirishnomalar bo\'limi qo\'shilmoqda', 'info');
            }

            handleSearch() {
                console.log('üîç Searching for:', this.searchTerm);
            }

            updateTime() {
                setInterval(() => {
                    this.currentTime = new Date();
                    const timeElement = document.getElementById('currentTime');
                    if (timeElement) {
                        timeElement.textContent = this.currentTime.toLocaleTimeString('uz-UZ', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                }, 1000);
            }

            updateLiveStats() {
                // Auto update functionality
            }

            startRealTimeUpdates() {
                // WebSocket connection for real-time updates
                this.initializeWebSocket();
            }

            initializeWebSocket() {
                try {
                    console.log('üîå Initializing WebSocket connection...');

                    // Initialize Socket.IO client
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const socketUrl = `${protocol}//${window.location.host}/dashboard`;

                    this.socket = io('/dashboard', {
                        transports: ['websocket', 'polling']
                    });

                    this.socket.on('connect', () => {
                        console.log('‚úÖ WebSocket connected successfully');
                        this.showNotification('Real-time yangilanishlar faol', 'success');
                    });

                    this.socket.on('disconnect', () => {
                        console.log('‚ùå WebSocket disconnected');
                        this.showNotification('Real-time yangilanishlar uzildi', 'warning');
                    });

                    // Listen for real-time updates
                    this.socket.on('order-update', (orderData) => {
                        console.log('üì¶ Received order update:', orderData);
                        this.handleOrderUpdate(orderData);
                    });

                    this.socket.on('order-status-change', (data) => {
                        console.log('üîÑ Order status changed:', data);
                        this.handleOrderStatusChange(data);
                    });

                    this.socket.on('new-order', (orderData) => {
                        console.log('üÜï New order received:', orderData);
                        this.handleNewOrder(orderData);
                    });

                    this.socket.on('driver-action', (data) => {
                        console.log('üöõ Driver action:', data);
                        this.handleDriverAction(data);
                    });

                    this.socket.on('stats-update', (stats) => {
                        console.log('üìä Stats updated:', stats);
                        this.handleStatsUpdate(stats);
                    });

                    this.socket.on('dashboard-stats', (stats) => {
                        console.log('üìà Dashboard stats received:', stats);
                        this.apiData.stats = stats;
                        if (this.currentPage === 'dashboard') {
                            this.loadPage('dashboard');
                        }
                    });

                } catch (error) {
                    console.error('‚ùå WebSocket initialization error:', error);
                    this.showNotification('Real-time yangilanishlar ishga tushmadi', 'error');
                }
            }

            // WebSocket event handlers
            handleOrderUpdate(orderData) {
                // Update order in current data
                if (this.apiData.orders) {
                    const orderIndex = this.apiData.orders.findIndex(o => o.id === orderData.id);
                    if (orderIndex !== -1) {
                        this.apiData.orders[orderIndex] = orderData;
                    } else {
                        this.apiData.orders.unshift(orderData);
                    }
                }

                // Refresh current page if we're viewing orders
                if (this.currentPage === 'orders' || this.currentPage === 'history') {
                    this.loadPage(this.currentPage);
                }

                this.showNotification('Buyurtma yangilandi', 'info');
            }

            handleOrderStatusChange(data) {
                // Update order status in current data
                if (this.apiData.orders) {
                    const orderIndex = this.apiData.orders.findIndex(o => o.id === data.orderId);
                    if (orderIndex !== -1) {
                        this.apiData.orders[orderIndex].status = data.status;
                        if (data.driverInfo) {
                            this.apiData.orders[orderIndex].driver = data.driverInfo.name || data.driverInfo;
                        }
                    }
                }

                // Refresh if viewing relevant pages
                if (this.currentPage === 'orders' || this.currentPage === 'history') {
                    this.loadPage(this.currentPage);
                }

                this.showNotification(`Buyurtma holati: ${data.status}`, 'info');
            }

            handleNewOrder(orderData) {
                // Add new order to current data
                if (!this.apiData.orders) {
                    this.apiData.orders = [];
                }
                this.apiData.orders.unshift(orderData);

                // Refresh if viewing orders page
                if (this.currentPage === 'orders') {
                    this.loadPage('orders');
                }

                this.showNotification('Yangi buyurtma qabul qilindi', 'success');
            }

            handleDriverAction(data) {
                // Handle driver actions (accept, reject, etc.)
                if (this.currentPage === 'orders' || this.currentPage === 'drivers') {
                    this.loadPage(this.currentPage);
                }

                this.showNotification(`Haydovchi ${data.action}`, 'info');
            }

            handleStatsUpdate(stats) {
                // Update statistics in real-time
                this.apiData.stats = { ...this.apiData.stats, ...stats };

                // Update live activity numbers
                if (document.getElementById('liveDrivers')) {
                    document.getElementById('liveDrivers').textContent = stats.drivers || 89;
                }
                if (document.getElementById('liveOrders')) {
                    document.getElementById('liveOrders').textContent = stats.orders || 247;
                }
                if (document.getElementById('liveRevenue')) {
                    document.getElementById('liveRevenue').textContent = this.formatCurrency(stats.revenue || 2456700);
                }

                // Refresh dashboard if currently viewing
                if (this.currentPage === 'dashboard') {
                    this.loadPage('dashboard');
                }
            }

            // Order history filter functions
            setHistoryFilter(filterType, value) {
                console.log('üîç Setting history filter:', filterType, value);
                this.orderHistoryFilters[filterType] = value;

                // Re-render order history with new filters
                if (this.currentPage === 'history') {
                    this.loadPage('history');
                }
            }

            applyOrderHistoryFilters(allOrders) {
                let filtered = [...allOrders];

                // Status filter
                if (this.orderHistoryFilters.status !== 'all') {
                    filtered = filtered.filter(order => order.status === this.orderHistoryFilters.status);
                }

                // Source filter
                if (this.orderHistoryFilters.source !== 'all') {
                    filtered = filtered.filter(order => {
                        const source = this.getOrderSourceType(order);
                        return source === this.orderHistoryFilters.source;
                    });
                }

                // Date range filter
                if (this.orderHistoryFilters.dateRange !== 'all') {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                    filtered = filtered.filter(order => {
                        // Use dateTime field if available, otherwise parse date field
                        let orderDate;
                        if (order.dateTime) {
                            orderDate = new Date(order.dateTime);
                        } else {
                            // Handle different date formats
                            let dateStr = order.date;
                            if (typeof dateStr === 'string') {
                                // Convert DD.MM.YYYY to YYYY-MM-DD format
                                if (dateStr.includes('.')) {
                                    const parts = dateStr.split('.');
                                    if (parts.length === 3) {
                                        dateStr = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                    }
                                }
                            }
                            orderDate = new Date(dateStr);
                        }

                        // Debug log
                        console.log('Date filter debug:', {
                            orderDate: order.date,
                            orderDateTime: order.dateTime,
                            parsedDate: orderDate,
                            today: today,
                            filter: this.orderHistoryFilters.dateRange
                        });

                        // Check if date is valid
                        if (isNaN(orderDate.getTime())) {
                            console.warn('Invalid order date:', order.date, order.dateTime);
                            return false;
                        }

                        switch (this.orderHistoryFilters.dateRange) {
                            case 'today':
                                return orderDate >= today;
                            case 'week':
                                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                                return orderDate >= weekAgo;
                            case 'month':
                                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                                return orderDate >= monthAgo;
                            default:
                                return true;
                        }
                    });
                }

                return filtered;
            }

            getOrderSource(order) {
                const sourceType = this.getOrderSourceType(order);
                const sourceLabels = {
                    'yukchi': 'üë§ Yukchi',
                    'dispechr': 'üéß Dispechr',
                    'admin': 'üë®‚Äçüíº Admin'
                };
                return sourceLabels[sourceType] || '‚ùì Noma\'lum';
            }

            getOrderSourceType(order) {
                if (order.customer === 'Admin Dashboard' || order.id.includes('dashboard')) {
                    return 'admin';
                }
                // You can add more logic here to detect dispechr vs yukchi
                // For now, assume non-admin orders are from yukchi
                return 'yukchi';
            }

            // Clear all filters method
            clearAllHistoryFilters() {
                console.log('üßπ Clearing all history filters...');
                this.orderHistoryFilters = {
                    status: 'all',
                    source: 'all',
                    dateRange: 'all'
                };
                // Re-render order history
                if (this.currentPage === 'history') {
                    this.loadPage('history');
                }
                this.showNotification('Barcha filtrlar tozalandi', 'success');
            }

            // Order management methods
            async cancelOrder(orderId) {
                try {
                    console.log('‚ùå Cancelling order:', orderId);

                    if (!confirm('Bu buyurtmani bekor qilishni xohlaysizmi? Barcha haydovchilardan olib tashlanadi.')) {
                        return;
                    }

                    const response = await fetch(`/api/dashboard/orders/${orderId}/cancel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Order cancelled successfully:', result);
                        this.showNotification('Buyurtma bekor qilindi va barcha haydovchilardan olib tashlandi', 'success');

                        // Refresh current page
                        await this.loadApiData();
                        this.loadPage(this.currentPage);
                    } else {
                        throw new Error('Server xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Error cancelling order:', error);
                    this.showNotification('Buyurtmani bekor qilishda xatolik yuz berdi', 'error');
                }
            }

            async resendOrder(orderId) {
                try {
                    console.log('üîÑ Resending order to drivers:', orderId);

                    const response = await fetch(`/api/dashboard/orders/${orderId}/resend`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Order resent successfully:', result);
                        this.showNotification('Buyurtma qayta haydovchilarga yuborildi', 'success');

                        // Refresh current page
                        await this.loadApiData();
                        this.loadPage(this.currentPage);
                    } else {
                        throw new Error('Server xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Error resending order:', error);
                    this.showNotification('Buyurtmani qayta yuborishda xatolik yuz berdi', 'error');
                }
            }

            async viewOrderDetails(orderId) {
                try {
                    console.log('üëÅÔ∏è Viewing order details:', orderId);

                    const response = await fetch(`/api/dashboard/orders/${orderId}`);
                    const orderData = await response.json();

                    if (!orderData.success) {
                        if (orderData.error === 'ORDER_NOT_ACTIVE') {
                            this.showNotification('Bu buyurtma allaqachon bajarilgan yoki bekor qilingan', 'warning');
                            // Refresh page to remove inactive orders
                            await this.loadApiData();
                            this.loadPage(this.currentPage);
                            return;
                        } else {
                            throw new Error(orderData.message || 'Xatolik yuz berdi');
                        }
                    }

                    if (response.ok && orderData.success) {
                        // Create a detailed view modal
                        const modalContent = `
                            <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 25px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
                                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">Buyurtma Tafsilotlari</h2>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                                </div>
                                <div style="space-y: 1rem;">
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Buyurtma ID:</strong>
                                        <span>${orderData.data?.id || orderId}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Mijoz:</strong>
                                        <span>${orderData.data?.customer || 'Ma\'lumot yo\'q'}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Marshrut:</strong>
                                        <span>${orderData.data?.route || 'Ma\'lumot yo\'q'}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Yuk turi:</strong>
                                        <span>${orderData.data?.cargoType || 'Ma\'lumot yo\'q'}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Summa:</strong>
                                        <span style="font-weight: 600; color: #059669;">${this.formatCurrency(orderData.data?.amount || 0)}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Haydovchi:</strong>
                                        <span>${orderData.data?.driver || 'Kutilmoqda...'}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Holat:</strong>
                                        <span>${orderData.data?.status || 'Ma\'lumot yo\'q'}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <strong style="color: #374151;">Sana:</strong>
                                        <span>${orderData.data?.date || 'Ma\'lumot yo\'q'}</span>
                                    </div>
                                </div>
                                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">Yopish</button>
                                </div>
                            </div>
                        `;

                        // Create overlay
                        const overlay = document.createElement('div');
                        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 2rem;';
                        overlay.innerHTML = modalContent;

                        document.body.appendChild(overlay);

                        // Close on overlay click
                        overlay.addEventListener('click', (e) => {
                            if (e.target === overlay) {
                                overlay.remove();
                            }
                        });

                    } else {
                        throw new Error('Server xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Error viewing order details:', error);
                    this.showNotification('Buyurtma tafsilotlarini olishda xatolik yuz berdi', 'error');
                }
            }

            // Driver management methods
            openBalanceTopUpModal(driverId, driverName) {
                const modalContent = `
                    <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 25px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">üí∞ Balansni to'ldirish</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                        </div>
                        <div style="margin-bottom: 2rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <strong style="color: #374151;">Haydovchi:</strong> ${driverName}
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">To'ldirish summasi (so'm)</label>
                                <input type="number" id="topUpAmount" placeholder="Miqdorni kiriting..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Izoh (ixtiyoriy)</label>
                                <textarea id="topUpNote" placeholder="Izoh..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; resize: vertical; height: 80px; box-sizing: border-box;"></textarea>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="modal-cancel-btn" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Bekor qilish</button>
                            <button class="modal-balance-submit-btn" data-driver-id="${driverId}" data-driver-name="${driverName}" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">üí∞ To'ldirish</button>
                        </div>
                    </div>
                `;

                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 2rem;';
                overlay.innerHTML = modalContent;

                document.body.appendChild(overlay);

                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });

                // Focus amount input
                setTimeout(() => {
                    const amountInput = document.getElementById('topUpAmount');
                    if (amountInput) amountInput.focus();
                }, 100);
            }

            openPenaltyDeductModal(driverId, driverName) {
                const modalContent = `
                    <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 25px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: #dc2626; margin: 0;">‚ö†Ô∏è Jarima yechish</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                        </div>
                        <div style="margin-bottom: 2rem;">
                            <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <strong style="color: #dc2626;">‚ö†Ô∏è Diqqat:</strong> Bu amal haydovchi balansidan pul yechib tashlaydi!
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <strong style="color: #374151;">Haydovchi:</strong> ${driverName}
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Jarima summasi (so'm)</label>
                                <input type="number" id="penaltyAmount" placeholder="Jarima miqdorini kiriting..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Jarima sababi (majburiy)</label>
                                <textarea id="penaltyReason" placeholder="Jarima sababini yozing..." required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; resize: vertical; height: 80px; box-sizing: border-box;"></textarea>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="modal-cancel-btn" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Bekor qilish</button>
                            <button class="modal-penalty-submit-btn" data-driver-id="${driverId}" data-driver-name="${driverName}" style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">‚ö†Ô∏è Jarima yech</button>
                        </div>
                    </div>
                `;

                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 2rem;';
                overlay.innerHTML = modalContent;

                document.body.appendChild(overlay);

                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });

                // Focus amount input
                setTimeout(() => {
                    const amountInput = document.getElementById('penaltyAmount');
                    if (amountInput) amountInput.focus();
                }, 100);
            }

            openAddDriverModal() {
                console.log('‚ûï Opening add driver modal...');

                const modalContent = `
                    <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 25px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">üë®‚Äçüíº Yangi haydovchi qo'shish</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                        </div>

                        <form id="addDriverForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Ism</label>
                                    <input type="text" name="firstName" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="Masalan: Alisher">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Familiya</label>
                                    <input type="text" name="lastName" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="Masalan: Karimov">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Telefon raqami</label>
                                    <input type="tel" name="phone" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="+998901234567">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Telegram username</label>
                                    <input type="text" name="username" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="@username (ixtiyoriy)">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Mashina turi</label>
                                    <select name="vehicleType" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;">
                                        <option value="">Mashina turini tanlang</option>
                                        <option value="Gazel">Gazel</option>
                                        <option value="Kamaz">Kamaz</option>
                                        <option value="Fura">Fura</option>
                                        <option value="Man">Man</option>
                                        <option value="Yengil mashina">Yengil mashina</option>
                                        <option value="Boshqa">Boshqa</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Yuk ko'tarish qobiliyati</label>
                                    <input type="text" name="capacity" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="Masalan: 3 tonna">
                                </div>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Mashina davlat raqami</label>
                                <input type="text" name="vehicleNumber" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="Masalan: 01A001AA">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Boshlang'ich balans (so'm)</label>
                                <input type="number" name="initialBalance" value="0" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;" placeholder="0">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Qo'shimcha ma'lumot</label>
                                <textarea name="notes" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; resize: vertical; height: 80px; box-sizing: border-box;" placeholder="Qo'shimcha ma'lumotlar (ixtiyoriy)"></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                                <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Bekor qilish</button>
                                <button type="submit" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">üë®‚Äçüíº Qo'shish</button>
                            </div>
                        </form>
                    </div>
                `;

                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 2rem;';
                overlay.innerHTML = modalContent;
                document.body.appendChild(overlay);

                // Set up form submission
                const form = document.getElementById('addDriverForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.processAddDriver(form, overlay);
                    });
                }

                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });

                // Focus first input
                setTimeout(() => {
                    const firstInput = form.querySelector('input[name="firstName"]');
                    if (firstInput) firstInput.focus();
                }, 100);
            }

            async processAddDriver(form, overlay) {
                try {
                    const formData = new FormData(form);
                    const driverData = {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        fullName: `${formData.get('firstName')} ${formData.get('lastName')}`,
                        phone: formData.get('phone'),
                        username: formData.get('username') || '',
                        vehicleType: formData.get('vehicleType'),
                        capacity: formData.get('capacity'),
                        vehicleNumber: formData.get('vehicleNumber') || '',
                        initialBalance: parseInt(formData.get('initialBalance')) || 0,
                        notes: formData.get('notes') || ''
                    };

                    console.log('üìù Adding new driver:', driverData);

                    // Create loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Qo\'shilmoqda...';
                    submitBtn.disabled = true;

                    // API call to add driver
                    const response = await fetch('/api/dashboard/drivers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(driverData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Driver added successfully:', result);

                        this.showNotification('Haydovchi muvaffaqiyatli qo\'shildi!', 'success');
                        overlay.remove();

                        // Refresh drivers list
                        await this.loadApiData();
                        this.loadPage('drivers');
                    } else {
                        throw new Error('Server xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Error adding driver:', error);
                    this.showNotification('Haydovchi qo\'shishda xatolik yuz berdi', 'error');

                    // Restore button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = 'üë®‚Äçüíº Qo\'shish';
                        submitBtn.disabled = false;
                    }
                }
            }

            async processBalanceTopUp(driverId, driverName, button) {
                try {
                    const amountInput = document.getElementById('topUpAmount');
                    const noteInput = document.getElementById('topUpNote');

                    const amount = parseFloat(amountInput.value);
                    const note = noteInput.value.trim();

                    if (!amount || amount <= 0) {
                        this.showNotification('Iltimos, to\'ldirish summasini kiriting', 'error');
                        return;
                    }

                    if (amount > 10000000) { // 10 million limit
                        this.showNotification('Maksimal to\'ldirish summasi: 10,000,000 so\'m', 'error');
                        return;
                    }

                    // Disable button and show loading
                    button.disabled = true;
                    button.innerHTML = '‚è≥ To\'ldirilmoqda...';

                    console.log('üí∞ Processing balance top-up for driver:', driverId, amount);

                    const response = await fetch(`/api/dashboard/drivers/${driverId}/add-balance`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount: amount,
                            note: note
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Balance topped up successfully:', result);

                        this.showNotification(`${driverName} haydovchisiga ${this.formatCurrency(amount)} to'ldirildi`, 'success');

                        // Close modal
                        button.parentElement.parentElement.parentElement.remove();

                        // Refresh drivers page
                        await this.loadApiData();
                        this.loadPage('drivers');
                    } else {
                        throw new Error('Server xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Error processing balance top-up:', error);
                    this.showNotification('Balansni to\'ldirishda xatolik yuz berdi', 'error');

                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = 'üí∞ To\'ldirish';
                }
            }

            async processPenaltyDeduct(driverId, driverName, button) {
                try {
                    const amountInput = document.getElementById('penaltyAmount');
                    const reasonInput = document.getElementById('penaltyReason');

                    const amount = parseFloat(amountInput.value);
                    const reason = reasonInput.value.trim();

                    if (!amount || amount <= 0) {
                        this.showNotification('Iltimos, jarima summasini kiriting', 'error');
                        return;
                    }

                    if (!reason) {
                        this.showNotification('Jarima sababini kiritish majburiy', 'error');
                        return;
                    }

                    if (amount > 1000000) { // 1 million limit for penalties
                        this.showNotification('Maksimal jarima summasi: 1,000,000 so\'m', 'error');
                        return;
                    }

                    // Confirmation dialog
                    if (!confirm(`‚ö†Ô∏è DIQQAT!\n\nHaydovchi: ${driverName}\nJarima: ${amount.toLocaleString()} so'm\nSabab: ${reason}\n\nRostdan ham jarima yechmoqchimisiz?`)) {
                        return;
                    }

                    // Disable button and show loading
                    button.disabled = true;
                    button.innerHTML = '‚è≥ Yechilmoqda...';

                    console.log('‚ö†Ô∏è Processing penalty deduction for driver:', driverId, amount);

                    const response = await fetch(`/api/dashboard/drivers/${driverId}/deduct-penalty`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount: amount,
                            reason: reason
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        if (result.success) {
                            this.showNotification(`‚úÖ Jarima muvaffaqiyatli yechildi: ${amount.toLocaleString()} so'm`, 'success');

                            // Close modal
                            button.closest('.modal-overlay') ? button.closest('.modal-overlay').remove() :
                            button.parentElement.parentElement.parentElement.remove();

                            // Refresh drivers data
                            await this.loadData();
                        } else {
                            throw new Error(result.message || 'Jarima yechishda xatolik');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    console.error('‚ùå Error processing penalty deduction:', error);
                    this.showNotification('Jarima yechishda xatolik yuz berdi', 'error');

                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = '‚ö†Ô∏è Jarima yech';
                }
            }

            async viewDriverDetails(driverId) {
                try {
                    console.log('üëÅÔ∏è Viewing driver details:', driverId);

                    const response = await fetch(`/api/dashboard/drivers/${driverId}`);
                    if (response.ok) {
                        const driverData = await response.json();
                        const driver = driverData.data;

                        const modalContent = `
                            <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 25px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
                                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">üë®‚Äçüíº Haydovchi Tafsilotlari</h2>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem;">√ó</button>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                    <div>
                                        <h3 style="color: #374151; margin-bottom: 1rem; font-size: 1.1rem;">Shaxsiy ma'lumotlar</h3>
                                        <div style="space-y: 1rem;">
                                            <div style="margin-bottom: 1rem;">
                                                <strong style="color: #374151;">Ism familiya:</strong>
                                                <div style="color: #6b7280; margin-top: 0.25rem;">${driver?.fullName || driver?.name || 'Ma\'lumot yo\'q'}</div>
                                            </div>
                                            <div style="margin-bottom: 1rem;">
                                                <strong style="color: #374151;">Telefon raqam:</strong>
                                                <div style="color: #6b7280; margin-top: 0.25rem;">${this.formatPhoneNumber(driver?.phone) || 'Ma\'lumot yo\'q'}</div>
                                            </div>
                                            <div style="margin-bottom: 1rem;">
                                                <strong style="color: #374151;">Transport:</strong>
                                                <div style="color: #6b7280; margin-top: 0.25rem;">${driver?.vehicle || 'Ma\'lumot yo\'q'}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 style="color: #374151; margin-bottom: 1rem; font-size: 1.1rem;">Faoliyat</h3>
                                        <div style="space-y: 1rem;">
                                            <div style="margin-bottom: 1rem;">
                                                <strong style="color: #374151;">Joriy balans:</strong>
                                                <div style="color: #059669; margin-top: 0.25rem; font-weight: 600; font-size: 1.1rem;">${this.formatCurrency(driver?.balance || 0)}</div>
                                            </div>
                                            <div style="margin-bottom: 1rem;">
                                                <strong style="color: #374151;">Buyurtmalar soni:</strong>
                                                <div style="color: #6b7280; margin-top: 0.25rem;">${driver?.orders || 0} ta</div>
                                            </div>
                                            <div style="margin-bottom: 1rem;">
                                                <strong style="color: #374151;">Reyting:</strong>
                                                <div style="color: #6b7280; margin-top: 0.25rem; display: flex; align-items: center;">
                                                    <i class="fas fa-star" style="color: #fbbf24; margin-right: 0.5rem;"></i>
                                                    ${driver?.rating?.toFixed(1) || 'N/A'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                                    <button onclick="dashboard.callDriver('${driver?.phone}')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">üìû Qo'ng'iroq qilish</button>
                                    <button onclick="dashboard.openBalanceTopUpModal('${driver?.realId || driverId}', '${driver?.fullName || driver?.name}'); this.parentElement.parentElement.parentElement.remove();" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">üí∞ Balans to'ldirish</button>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Yopish</button>
                                </div>
                            </div>
                        `;

                        // Create overlay
                        const overlay = document.createElement('div');
                        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 2rem;';
                        overlay.innerHTML = modalContent;

                        document.body.appendChild(overlay);

                        // Close on overlay click
                        overlay.addEventListener('click', (e) => {
                            if (e.target === overlay) {
                                overlay.remove();
                            }
                        });
                    } else {
                        throw new Error('Server xatosi');
                    }
                } catch (error) {
                    console.error('‚ùå Error viewing driver details:', error);
                    this.showNotification('Haydovchi ma\'lumotlarini olishda xatolik yuz berdi', 'error');
                }
            }

            callDriver(phoneNumber) {
                if (phoneNumber && phoneNumber !== 'Ma\'lumot yo\'q') {
                    // Attempt to open phone dialer
                    window.open(`tel:${phoneNumber}`, '_self');
                    this.showNotification(`${phoneNumber} raqamiga qo'ng'iroq qilish...`, 'info');
                } else {
                    this.showNotification('Telefon raqam mavjud emas', 'error');
                }
            }

            // WebSocket initialization and handlers
            initializeWebSocket() {
                try {
                    this.socket = io();
                    console.log('üîå WebSocket attempting to connect...');

                    this.socket.on('connect', () => {
                        console.log('‚úÖ WebSocket connected successfully');
                        this.showNotification('Real-time ulanish faol', 'success');
                    });

                    this.socket.on('disconnect', () => {
                        console.log('‚ùå WebSocket disconnected');
                        this.showNotification('Real-time ulanish uzildi', 'warning');
                    });

                    // Listen for new orders
                    this.socket.on('new-order', (data) => {
                        console.log('üì¶ New order received:', data);
                        this.showNotification(`Yangi buyurtma: ${data.fromCity} ‚Üí ${data.toCity}`, 'info');
                        if (this.currentPage === 'orders' || this.currentPage === 'dashboard' || this.currentPage === 'history') {
                            this.loadApiData().then(() => {
                                this.loadPage(this.currentPage);
                            });
                        }
                    });

                    // Listen for order updates
                    this.socket.on('order-update', (data) => {
                        console.log('üîÑ Order updated:', data);
                        this.showNotification(`Buyurtma yangilandi: ${data.orderId}`, 'info');
                        if (this.currentPage === 'orders' || this.currentPage === 'dashboard' || this.currentPage === 'history') {
                            this.loadApiData().then(() => {
                                this.loadPage(this.currentPage);
                            });
                        }
                    });

                    // Listen for driver balance updates
                    this.socket.on('driver-balance-update', (data) => {
                        console.log('üí∞ Driver balance updated:', data);
                        this.showNotification(`Haydovchi balansi yangilandi: +${data.addedAmount} so'm`, 'success');
                        if (this.currentPage === 'drivers') {
                            this.loadApiData().then(() => {
                                this.loadPage(this.currentPage);
                            });
                        }
                    });

                    // Listen for driver status updates
                    this.socket.on('driver-status-update', (data) => {
                        console.log('üë®‚Äçüíº Driver status updated:', data);
                        this.showNotification(`Haydovchi holati o'zgarti: ${data.status}`, 'info');
                        if (this.currentPage === 'drivers') {
                            this.loadApiData().then(() => {
                                this.loadPage(this.currentPage);
                            });
                        }
                    });

                } catch (error) {
                    console.error('‚ùå WebSocket initialization error:', error);
                    this.showNotification('Real-time ulanishda xatolik', 'error');
                }
            }

            // Phone number formatting utility function
            formatPhoneNumber(phone) {
                if (!phone) return 'Noma\'lum';

                // Remove all non-digit characters except +
                let cleaned = phone.replace(/[^\d+]/g, '');

                // Handle different phone number formats
                if (cleaned.startsWith('+998')) {
                    // Already in correct format: +998901234567
                    return cleaned.replace(/(\+998)(\d{2})(\d{3})(\d{2})(\d{2})/, '$1 $2 $3-$4-$5');
                } else if (cleaned.startsWith('998')) {
                    // Missing +: 998901234567
                    return cleaned.replace(/^998(\d{2})(\d{3})(\d{2})(\d{2})/, '+998 $1 $2-$3-$4');
                } else if (cleaned.length === 9 && /^(90|91|93|94|95|97|98|99)/.test(cleaned)) {
                    // Local format: 901234567
                    return cleaned.replace(/^(\d{2})(\d{3})(\d{2})(\d{2})/, '+998 $1 $2-$3-$4');
                } else if (cleaned.startsWith('+')) {
                    // Other international format
                    return phone;
                } else {
                    // Unknown format, return as is but clean
                    return cleaned || 'Noma\'lum';
                }
            }
        }

        // Initialize dashboard when DOM is loaded
        if (!window.dashboard) {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üöÄ Initializing LogiMaster Pro Dashboard...');
                window.dashboard = new LogiMasterDashboard();

                // Setup global event delegation for driver buttons
                window.dashboard.setupGlobalEventDelegation();

                // Restore and load the current page after initialization
                setTimeout(() => {
                    const savedPage = localStorage.getItem('dashboardCurrentPage') || 'dashboard';
                    console.log('üîÑ Restoring page from localStorage:', savedPage);
                    window.dashboard.setActivePage(savedPage);
                    window.dashboard.loadPage(savedPage);
                }, 100);
            });
        }
    </script>
    <script>
        // Update time every second
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('uz-UZ', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        setInterval(updateTime, 1000);
        updateTime(); // Initial call

        // Logout function
        async function logout() {
            if (confirm('Rostdan ham tizimdan chiqmoqchimisiz?')) {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Muvaffaqiyatli chiqtingiz!');
                        window.location.href = result.redirect;
                    } else {
                        alert('Xatolik yuz berdi!');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Tarmoq xatosi yuz berdi!');
                }
            }
        }

        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/check');
                const result = await response.json();

                if (!result.isAuthenticated) {
                    window.location.href = '/auth/login';
                    return;
                }

                // Update user info if needed
                if (result.user) {
                    const userNameElement = document.querySelector('.user-name');
                    if (userNameElement) {
                        userNameElement.textContent = result.user.role === 'super_admin' ? 'Super Admin' : result.user.username;
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // Don't redirect on error - might be network issue
            }
        }

        // Check auth status on page load
        document.addEventListener('DOMContentLoaded', checkAuthStatus);

        // Global function for opening driver orders modal
        window.openDriverOrdersModal = async function(driverId, driverName) {
            try {
                console.log('üìã Opening driver orders modal:', { driverId, driverName });

                // Show loading
                const loadingModal = document.createElement('div');
                loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                loadingModal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                        <div style="width: 2rem; height: 2rem; border: 3px solid #e5e7eb; border-left: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                        <p>Buyurtmalar yuklanmoqda...</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Fetch driver orders
                const response = await fetch(`/api/dashboard/drivers/${driverId}/orders`);
                const result = await response.json();

                // Remove loading
                loadingModal.remove();

                if (!result.success) {
                    throw new Error(result.message || 'Xatolik yuz berdi');
                }

                const orders = result.data || [];
                const stats = result.stats || {};

                // Create orders table
                const ordersTable = orders.length > 0 ? orders.map(order => `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 0.75rem; font-family: monospace; font-size: 0.75rem; font-weight: 600; color: #3b82f6;">${order.id}</td>
                        <td style="padding: 0.75rem;">${order.customerName}</td>
                        <td style="padding: 0.75rem; font-weight: 500;">${order.route}</td>
                        <td style="padding: 0.75rem;">${order.cargoType}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #059669;">${dashboard.formatCurrency(order.price)}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #dc2626;">${dashboard.formatCurrency(order.commission)}</td>
                        <td style="padding: 0.75rem; font-size: 0.75rem; color: #6b7280;">${dashboard.formatDate(order.completedDate)}</td>
                        <td style="padding: 0.75rem;">
                            ${order.rating ? `
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-star" style="color: #fbbf24; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.875rem; font-weight: 500;">${order.rating}</span>
                                </div>
                            ` : '<span style="color: #9ca3af; font-size: 0.75rem;">Baholanmagan</span>'}
                        </td>
                    </tr>
                `).join('') : `
                    <tr>
                        <td colspan="8" style="padding: 2rem; text-align: center; color: #6b7280;">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                            Bu haydovchi hali buyurtma bajarmagan
                        </td>
                    </tr>
                `;

                // Create modal content
                const modalContent = `
                    <div style="background: white; border-radius: 1rem; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">
                                    üìã ${driverName} - Buyurtmalar tarixi
                                </h3>
                                <p style="color: #6b7280; font-size: 0.875rem;">Haydovchi tomonidan bajarilgan barcha buyurtmalar</p>
                            </div>
                            <button onclick="event.stopPropagation(); this.closest('[style*=\"position: fixed\"]').remove()" style="background: #f3f4f6; border: none; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #6b7280; font-size: 1.25rem;">
                                √ó
                            </button>
                        </div>

                        <!-- Statistics -->
                        <div style="padding: 1.5rem; background: #f9fafb; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: white; padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.25rem;">${stats.totalOrders || 0}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Jami buyurtmalar</div>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #059669;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #059669; margin-bottom: 0.25rem;">${dashboard.formatCurrency(stats.totalRevenue || 0)}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Jami daromad</div>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #dc2626;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626; margin-bottom: 0.25rem;">${dashboard.formatCurrency(stats.totalCommission || 0)}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Bizga to'lagan komisya (10%)</div>
                            </div>
                        </div>

                        <!-- Orders Table -->
                        <div style="padding: 1.5rem;">
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">ID</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Mijoz</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Yo'nalish</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Yuk turi</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Narx</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Komisya</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Sana</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Reyting</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ordersTable}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="dashboard.exportDriverOrders('${driverId}', '${driverName}')" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-download"></i>
                                Excel yuklash
                            </button>
                            <button onclick="event.stopPropagation(); this.closest('[style*=\"position: fixed\"]').remove()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">
                                Yopish
                            </button>
                        </div>
                    </div>
                `;

                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;';
                overlay.innerHTML = modalContent;

                document.body.appendChild(overlay);

                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        e.preventDefault();
                        e.stopPropagation();
                        overlay.remove();
                    }
                });

                // Add escape key handler
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        e.stopPropagation();
                        overlay.remove();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);

            } catch (error) {
                console.error('‚ùå Error opening driver orders modal:', error);
                alert('Haydovchi buyurtmalarini yuklashda xatolik: ' + error.message);
            }
        };

        // Shaharlar orasidagi masofalar (km)
        const cityDistances = {
            'Toshkent': {
                'Samarqand': 320, 'Buxoro': 465, 'Namangan': 230, 'Andijon': 280,
                'Farg\'ona': 270, 'Nukus': 800, 'Qarshi': 390, 'Termez': 680,
                'Urgench': 750, 'Navoiy': 360, 'Jizzax': 180, 'Gulistan': 120,
                'Kokand': 250, 'Margilan': 275
            },
            'Samarqand': {
                'Toshkent': 320, 'Buxoro': 280, 'Qarshi': 140, 'Termez': 360,
                'Navoiy': 210, 'Jizzax': 150, 'Nukus': 520, 'Urgench': 470,
                'Namangan': 380, 'Andijon': 430, 'Farg\'ona': 420
            },
            'Buxoro': {
                'Toshkent': 465, 'Samarqand': 280, 'Nukus': 340, 'Urgench': 290,
                'Navoiy': 150, 'Qarshi': 320, 'Termez': 480
            },
            'Namangan': {
                'Toshkent': 230, 'Andijon': 60, 'Farg\'ona': 80, 'Kokand': 50,
                'Margilan': 25, 'Samarqand': 380
            },
            'Andijon': {
                'Toshkent': 280, 'Namangan': 60, 'Farg\'ona': 40, 'Kokand': 25,
                'Margilan': 35, 'Samarqand': 430
            },
            'Farg\'ona': {
                'Toshkent': 270, 'Namangan': 80, 'Andijon': 40, 'Kokand': 35,
                'Margilan': 15, 'Samarqand': 420
            },
            'Nukus': {
                'Toshkent': 800, 'Buxoro': 340, 'Urgench': 200, 'Samarqand': 520
            },
            'Urgench': {
                'Toshkent': 750, 'Buxoro': 290, 'Nukus': 200, 'Samarqand': 470
            },
            'Qarshi': {
                'Toshkent': 390, 'Samarqand': 140, 'Termez': 220, 'Buxoro': 320
            },
            'Termez': {
                'Toshkent': 680, 'Samarqand': 360, 'Qarshi': 220, 'Buxoro': 480
            },
            'Navoiy': {
                'Toshkent': 360, 'Samarqand': 210, 'Buxoro': 150
            },
            'Jizzax': {
                'Toshkent': 180, 'Samarqand': 150
            },
            'Gulistan': {
                'Toshkent': 120
            },
            'Kokand': {
                'Toshkent': 250, 'Namangan': 50, 'Andijon': 25, 'Farg\'ona': 35,
                'Margilan': 20
            },
            'Margilan': {
                'Toshkent': 275, 'Namangan': 25, 'Andijon': 35, 'Farg\'ona': 15,
                'Kokand': 20
            }
        };

        // Masofa va vaqt hisoblash funksiyasi
        function calculateRouteInfo(fromCity, toCity) {
            if (!fromCity || !toCity || fromCity === toCity) {
                return null;
            }

            // Normalize city names
            fromCity = fromCity.trim();
            toCity = toCity.trim();

            let distance = null;

            // Direct distance lookup
            if (cityDistances[fromCity] && cityDistances[fromCity][toCity]) {
                distance = cityDistances[fromCity][toCity];
            } else if (cityDistances[toCity] && cityDistances[toCity][fromCity]) {
                distance = cityDistances[toCity][fromCity];
            }

            if (distance) {
                // Calculate approximate travel time (average speed 60 km/h)
                const travelTimeHours = Math.round((distance / 60) * 10) / 10;

                let timeString;
                if (travelTimeHours < 1) {
                    timeString = Math.round(travelTimeHours * 60) + ' daqiqa';
                } else if (travelTimeHours < 24) {
                    const hours = Math.floor(travelTimeHours);
                    const minutes = Math.round((travelTimeHours - hours) * 60);
                    timeString = hours + ' soat';
                    if (minutes > 0) {
                        timeString += ' ' + minutes + ' daqiqa';
                    }
                } else {
                    const days = Math.floor(travelTimeHours / 24);
                    const hours = Math.floor(travelTimeHours % 24);
                    timeString = days + ' kun';
                    if (hours > 0) {
                        timeString += ' ' + hours + ' soat';
                    }
                }

                return {
                    distance: distance,
                    time: timeString
                };
            }

            return null;
        }

        // Route info update function
        function updateRouteInfo() {
            const fromCity = document.getElementById('fromCity').value;
            const toCity = document.getElementById('toCity').value;
            const routeInfo = document.getElementById('routeInfo');
            const routeDistance = document.getElementById('routeDistance');
            const routeTime = document.getElementById('routeTime');

            const result = calculateRouteInfo(fromCity, toCity);

            if (result) {
                routeDistance.textContent = result.distance + ' km';
                routeTime.textContent = result.time;
                routeInfo.style.display = 'block';
            } else {
                routeInfo.style.display = 'none';
            }
        }

        // O'zbekiston shaharlar va tumanlar ro'yxati (300+)
        const uzbekistanCities = [
            // TOSHKENT VILOYATI
            'Toshkent', 'Tashkent', 'Bekabad', 'Chirchiq', 'Olmaliq', 'Angren', 'Yangiyul',
            'Yangiobod', 'Ohangaron', 'Bektemir', 'Sergeli', 'Shayxontohur', 'Yunusobod',
            'Uchtepa', 'Mirzo Ulug\'bek', 'Yakkasaroy', 'Mirobod', 'Chilonzor', 'Yashnobod',
            'Qoraqamish', 'Parkent', 'Chinoz', 'Zangiota', 'Qibray', 'Yuqoritepa', 'Pastdarg\'om',
            'Pskent', 'Quyichirchiq', 'O\'rtachirchiq', 'Bustonliq', 'Akhangaran', 'Bo\'ka',
            'Chartak', 'Chirchiqsoy', 'Quyi Chirchiq', 'O\'rta Chirchiq', 'Yuqori Chirchiq',

            // SAMARQAND VILOYATI
            'Samarqand', 'Samarkand', 'Urgut', 'Ishtixon', 'Jomboy', 'Kattaqo\'rg\'on', 'Narpay',
            'Nurobod', 'Payariq', 'Qarabuloq', 'Toyloq', 'Bulungur', 'Oqdaryo', 'Qo\'shrabot',
            'Pastdarg\'om', 'Ziadin', 'Kattakurgan', 'Paxtachi', 'Samarqand tumani', 'Pakhtachi',

            // BUXORO VILOYATI
            'Buxoro', 'Bukhara', 'Gijduvon', 'Romitan', 'Vobkent', 'Shofirkon', 'Olot', 'Peshku',
            'Qorako\'l', 'Qorovulbozor', 'Jondor', 'Kogon', 'G\'ijduvon', 'Buxoro tumani',
            'Romitan tumani', 'Vobkent tumani', 'Shofirkon tumani', 'Jondor tumani',

            // SURXONDARYO VILOYATI
            'Termez', 'Denov', 'Boysun', 'Jarqo\'rg\'on', 'Sherobod', 'Sho\'rchi', 'Bandixon',
            'Angor', 'Qiziriq', 'Qumqo\'rg\'on', 'Muzrabot', 'Oltinsoy', 'Sariosiyo', 'Uzun',
            'Termez tumani', 'Denov tumani', 'Boysun tumani', 'Jarqo\'rg\'on tumani',

            // QASHQADARYO VILOYATI
            'Qarshi', 'Chiroqchi', 'Dehqonobod', 'G\'uzor', 'Qamashi', 'Kasbi', 'Kitob', 'Koson',
            'Mirishkor', 'Muborak', 'Nishon', 'Shahrisabz', 'Yakkabog\'', 'Qarshi tumani',
            'Chiroqchi tumani', 'Dehqonobod tumani', 'G\'uzor tumani', 'Kamashi tumani',

            // FARG\'ONA VILOYATI
            'Farg\'ona', 'Fergana', 'Oltiariq', 'Bag\'dod', 'Beshariq', 'Buvayda', 'Dang\'ara',
            'Furqat', 'Qo\'qon', 'Kokand', 'Qo\'shtepa', 'Margilan', 'Rishton', 'So\'x', 'Toshloq',
            'Uchko\'prik', 'Yozyovon', 'Qo\'qon tumani', 'Margilan tumani', 'Farg\'ona tumani',
            'Oltiariq tumani', 'Bag\'dod tumani', 'Beshariq tumani', 'Buvayda tumani',

            // NAMANGAN VILOYATI
            'Namangan', 'Chortoq', 'Chust', 'Kosonsoy', 'Mingbuloq', 'Norin', 'Pop', 'To\'raqo\'rg\'on',
            'Uchqo\'rg\'on', 'Uychi', 'Yangiqo\'rg\'on', 'Namangan tumani', 'Chortoq tumani',
            'Chust tumani', 'Kosonsoy tumani', 'Mingbuloq tumani', 'Norin tumani', 'Pop tumani',

            // ANDIJON VILOYATI
            'Andijon', 'Andijan', 'Asaka', 'Baliqchi', 'Bo\'z', 'Buloqboshi', 'Izboskan', 'Jalaquduq',
            'Marhamat', 'Oltinko\'l', 'Paxtaobod', 'Qo\'rg\'ontepa', 'Shahrixon', 'Ulug\'nor',
            'Xo\'jaobod', 'Andijon tumani', 'Asaka tumani', 'Baliqchi tumani', 'Bo\'z tumani',

            // NAVOIY VILOYATI
            'Navoiy', 'Navoi', 'Karmana', 'Konimex', 'Navbahor', 'Nurota', 'Tomdi', 'Uchquduq',
            'Xatirchi', 'Zarafshan', 'Navoiy tumani', 'Karmana tumani', 'Navbahor tumani',
            'Nurota tumani', 'Tomdi tumani', 'Uchquduq tumani', 'Xatirchi tumani',

            // XORAZM VILOYATI
            'Urgench', 'Urganch', 'Bog\'ot', 'Gurlan', 'Xonqa', 'Xazorasp', 'Xiva', 'Khiva',
            'Qo\'shko\'pir', 'Shovot', 'Yangiariq', 'Yangibozor', 'Urgench tumani', 'Bog\'ot tumani',
            'Gurlan tumani', 'Xonqa tumani', 'Xazorasp tumani', 'Xiva tumani',

            // QORAQALPOG\'ISTON RESPUBLIKASI
            'Nukus', 'Amudaryo', 'Beruniy', 'Chimboy', 'Ellikqal\'a', 'Kegeyli', 'Qanliko\'l',
            'Mo\'ynoq', 'Qo\'ng\'irot', 'Shumanay', 'Taxtako\'pir', 'To\'rtko\'l', 'Xo\'jayli',
            'Nukus tumani', 'Amudaryo tumani', 'Beruniy tumani', 'Chimboy tumani',

            // JIZZAX VILOYATI
            'Jizzax', 'Arnasoy', 'Baxtiyor', 'Do\'stlik', 'Forish', 'G\'allaorol', 'Mirzacho\'l',
            'Paxtakor', 'Yangiobod', 'Zafarobod', 'Zarbdor', 'Zomin', 'Jizzax tumani',
            'Arnasoy tumani', 'Baxtiyor tumani', 'Do\'stlik tumani', 'Forish tumani',

            // SIRDARYO VILOYATI
            'Gulistan', 'Boyovut', 'Mirzaobod', 'Oqoltin', 'Sardoba', 'Sayxunobod', 'Xovos',
            'Yangiyer', 'Shirin', 'Gulistan tumani', 'Boyovut tumani', 'Mirzaobod tumani',
            'Oqoltin tumani', 'Sardoba tumani', 'Sayxunobod tumani', 'Xovos tumani',

            // QISHLOQ VA SHAHARCHA NOMLARI
            'Abdurahmonov', 'Abdulla Qodiriy', 'Afrosiyob', 'Agroservis', 'Ahmad Yassaviy',
            'Akhunbabaev', 'Akmal Ikramov', 'Akramkul', 'Alisher Navoiy', 'Amir Temur',
            'Andijan-1', 'Andijan-2', 'Arablar', 'Aral', 'Asadabad', 'Asakabank', 'Aydar',
            'Aybek', 'Azamjon', 'Aztag', 'Badiyon', 'Baglan', 'Bahmal', 'Bakht', 'Baliqchi',
            'Baxt', 'Bektemir', 'Beruni', 'Besharik', 'Beshtog', 'Birlik', 'Bobur', 'Bodom',
            'Bogcha', 'Bogiston', 'Boqijon', 'Boyobod', 'Boyqurg\'on', 'Bozchilik', 'Bozor',
            'Bunyodkor', 'Buston', 'Charvak', 'Chilonzor', 'Chinobod', 'Chirchiq', 'Chorsu',
            'Davlatobod', 'Dehqonobod', 'Dekhkanabad', 'Denov', 'Dostlik', 'Dug\'oba',
            'Eshonguzar', 'Farhod', 'Farish', 'Gazli', 'Gazalkent', 'Gijduvan', 'Gishtkoron',
            'Gulbahor', 'Guliston', 'Gulshan', 'Gulzor', 'Hazarasp', 'Haqiqat', 'Hoshimjon',
            'Hovliguzar', 'Ibrohim Mominov', 'Ibrohimjon', 'Ilovasikhon', 'Ilon', 'Ingliz',
            'Iqbol', 'Islomobod', 'Istiqlol', 'Janubiy', 'Jarqurghon', 'Jomboy', 'Jumabozor',
            'Kagan', 'Kamalak', 'Kamalik', 'Kamchiq', 'Kapchugay', 'Karmana', 'Kasansay',
            'Kattakorgan', 'Kavat', 'Kayragach', 'Kibray', 'Kitob', 'Kogon', 'Korako\'l',
            'Koshtepa', 'Krasnogorsk', 'Kuva', 'Langar', 'Latif', 'Madaniyat', 'Madrasa',
            'Margilon', 'Mashrab', 'Mehnat', 'Mingchinor', 'Mirobot', 'Moliya', 'Mubarak',
            'Mustaqillik', 'Namangancha', 'Nasaf', 'Navkar', 'Navoi', 'Nazarobod', 'Neftchilar',
            'Nukus', 'Nurlik', 'Nurota', 'Okhangaron', 'Olmaliq', 'Oltiariq', 'Oltinsoy',
            'Oqoltin', 'Orzu', 'Osh', 'Oydin', 'Ozodlik', 'Pahtakor', 'Pakhtakor', 'Pamir',
            'Parkent', 'Pastdargom', 'Paxtaobod', 'Paxtakor', 'Pogbon', 'Pop', 'Poytaxt',
            'Quyi Chirchiq', 'Qayragach', 'Qibla', 'Qizil Tepa', 'Qorabag', 'Qorako\'l',
            'Qorovulbozor', 'Qoshtepa', 'Quva', 'Ravot', 'Rayhon', 'Registon', 'Rishovut',
            'Romitan', 'Samarkand', 'Sardoba', 'Sariosiyo', 'Shabboz', 'Shahrisabz', 'Shakhristan',
            'Sharaf Rashidov', 'Sherabad', 'Sheroz', 'Shovot', 'Shurchi', 'Sobir Rakhimov',
            'Soldatskiy', 'Sovetobod', 'Sughd', 'Surxondaryo', 'Taboshar', 'Talimarzhan',
            'Tashkent', 'Termez', 'Teshiktosh', 'Tinchlik', 'Toshloq', 'Turtkul', 'Tuzel',
            'Uchkurgan', 'Uchtepa', 'Ulugbek', 'Urtasaroy', 'Usmat', 'Uzun', 'Vahdat',
            'Varzob', 'Vodil', 'Yangiarik', 'Yangibazar', 'Yangiobod', 'Yangiyo\'l',
            'Yarim', 'Yassavul', 'Yaypan', 'Yoshlik', 'Yulduz', 'Zafar', 'Zafarabad',
            'Zamin', 'Zarkainar', 'Zaynabobod', 'Ziadin', 'Zomin', 'Zukhra'
        ];

        // Autocomplete funksiyasi
        function setupAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            let currentHighlight = -1;

            console.log('Autocomplete setup for:', inputId, input, suggestions);

            if (!input || !suggestions) {
                console.error('Input or suggestions element not found:', inputId, suggestionsId);
                return;
            }

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                console.log('Input value:', value, 'Length:', value.length);
                suggestions.innerHTML = '';
                currentHighlight = -1;

                if (value.length < 2) {
                    suggestions.classList.remove('show');
                    return;
                }

                const filtered = uzbekistanCities.filter(city =>
                    city.toLowerCase().includes(value)
                ).slice(0, 8); // Faqat 8 ta natija ko'rsatish

                console.log('Filtered cities:', filtered);

                if (filtered.length > 0) {
                    filtered.forEach((city, index) => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = city;
                        div.addEventListener('click', function() {
                            input.value = city;
                            suggestions.classList.remove('show');
                            updateRouteInfo(); // Update route info when city is selected
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.classList.add('show');
                    console.log('Suggestions shown, count:', filtered.length);
                } else {
                    suggestions.classList.remove('show');
                    console.log('No suggestions found');
                }
            });

            // Keyboard navigation
            input.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('.autocomplete-suggestion');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentHighlight = Math.min(currentHighlight + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentHighlight = Math.max(currentHighlight - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentHighlight >= 0 && items[currentHighlight]) {
                        input.value = items[currentHighlight].textContent;
                        suggestions.classList.remove('show');
                        updateRouteInfo(); // Update route info when city is selected via keyboard
                    }
                } else if (e.key === 'Escape') {
                    suggestions.classList.remove('show');
                    currentHighlight = -1;
                }
            });

            function updateHighlight(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === currentHighlight);
                });
            }

            // Click outside to close
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.remove('show');
                }
            });
        }

        // Finance Dashboard Function
        async function showFinanceDashboard() {
            try {
                // Show loading
                const loadingModal = document.createElement('div');
                loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                loadingModal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                        <div style="width: 2rem; height: 2rem; border: 3px solid #e5e7eb; border-left: 3px solid #f093fb; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                        <p>Moliya ma'lumotlari yuklanmoqda...</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Fetch finance data
                const [dashboardRes, revenueRes, expensesRes, profitRes] = await Promise.all([
                    fetch('/api/finance/dashboard'),
                    fetch('/api/finance/revenue'),
                    fetch('/api/finance/expenses'),
                    fetch('/api/finance/profit')
                ]);

                const dashboard = await dashboardRes.json();
                const revenue = await revenueRes.json();
                const expenses = await expensesRes.json();
                const profit = await profitRes.json();

                // Remove loading
                loadingModal.remove();

                // Show finance modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;';

                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                        <!-- Header -->
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 1rem 1rem 0 0;">
                            <div>
                                <h2 style="margin: 0; font-size: 1.5rem;">üìä Moliya Dashboard</h2>
                                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Daromad, xarajat va foyda tahlili</p>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; width: 2.5rem; height: 2.5rem; border-radius: 50%; color: white; font-size: 1.25rem; cursor: pointer;">√ó</button>
                        </div>

                        <!-- Stats Cards -->
                        <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 1rem;">
                                <h3 style="margin: 0; font-size: 1rem; opacity: 0.9;">üí∞ Jami Daromad</h3>
                                <div style="font-size: 1.75rem; font-weight: 700; margin: 0.5rem 0;">${formatCurrency(dashboard.data?.totalRevenue || 0)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.8;">+${dashboard.data?.revenueGrowth?.toFixed(1) || 0}% o'sish</div>
                            </div>

                            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 1rem;">
                                <h3 style="margin: 0; font-size: 1rem; opacity: 0.9;">üí∏ Jami Xarajat</h3>
                                <div style="font-size: 1.75rem; font-weight: 700; margin: 0.5rem 0;">${formatCurrency(dashboard.data?.totalExpenses || 0)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.8;">Oylik xarajatlar</div>
                            </div>

                            <div style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 1.5rem; border-radius: 1rem;">
                                <h3 style="margin: 0; font-size: 1rem; opacity: 0.9;">üìà Sof Foyda</h3>
                                <div style="font-size: 1.75rem; font-weight: 700; margin: 0.5rem 0; color: ${(dashboard.data?.netProfit || 0) >= 0 ? '#ffffff' : '#fca5a5'}">${formatCurrency(dashboard.data?.netProfit || 0)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.8;">Foyda foizi: ${dashboard.data?.profitMargin?.toFixed(1) || 0}%</div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showExpenseForm()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-plus"></i> Xarajat qo'shish
                            </button>
                            <button onclick="showRevenueDetails()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-line"></i> Daromad tafsilotlari
                            </button>
                            <button onclick="showExpenseReport()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-receipt"></i> Xarajat hisoboti
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

            } catch (error) {
                console.error('Finance dashboard error:', error);
                alert('Moliya ma\'lumotlarini yuklashda xatolik yuz berdi');
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('uz-UZ').format(amount) + ' so\'m';
        }

        // Placeholder functions for finance actions
        function showExpenseForm() {
            alert('Xarajat qo\'shish formasi - tez orada...');
        }

        function showRevenueDetails() {
            alert('Daromad tafsilotlari - tez orada...');
        }

        function showExpenseReport() {
            alert('Xarajat hisoboti - tez orada...');
        }

        // Commission Management Function
        async function showCommissionManagement() {
            try {
                // Show loading
                const loadingModal = document.createElement('div');
                loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                loadingModal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                        <div style="width: 2rem; height: 2rem; border: 3px solid #e5e7eb; border-left: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                        <p>Komissiya ma'lumotlari yuklanmoqda...</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Fetch commission data
                const [ratesRes, rulesRes, driversRes] = await Promise.all([
                    fetch('/api/commission/rates'),
                    fetch('/api/commission/rules'),
                    fetch('/api/commission/drivers')
                ]);

                const rates = await ratesRes.json();
                const rules = await rulesRes.json();
                const drivers = await driversRes.json();

                // Remove loading
                loadingModal.remove();

                // Create commission rules options
                const ruleTypes = [
                    { type: 'percentage', name: 'Foizli Komissiya', icon: 'üìä', description: 'Buyurtma summasidan foiz' },
                    { type: 'fixed', name: 'Belgilangan Summa', icon: 'üí∞', description: 'Har bir buyurtma uchun doimiy summa' },
                    { type: 'daily', name: 'Kunlik Komissiya', icon: 'üìÖ', description: 'Kuniga bir marta to\'lanadigan komissiya' },
                    { type: 'weekly', name: 'Haftalik Komissiya', icon: 'üìÜ', description: 'Haftada bir marta to\'lanadigan komissiya' },
                    { type: 'monthly', name: 'Oylik Komissiya', icon: 'üìä', description: 'Oyda bir marta to\'lanadigan komissiya' }
                ];

                const rulesGrid = ruleTypes.map(rule => `
                    <div onclick="createCommissionRule('${rule.type}')" style="background: white; border: 2px solid #e5e7eb; border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s; hover:border-color: #667eea;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${rule.icon}</div>
                        <h4 style="margin: 0; color: #1f2937; font-size: 1rem;">${rule.name}</h4>
                        <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.875rem;">${rule.description}</p>
                    </div>
                `).join('');

                // Show commission modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;';

                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                        <!-- Header -->
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem 1rem 0 0;">
                            <div>
                                <h2 style="margin: 0; font-size: 1.5rem;">üí∞ Komissiya Boshqaruvi</h2>
                                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Moslashuvchan komissiya qoidalarini boshqaring</p>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; width: 2.5rem; height: 2.5rem; border-radius: 50%; color: white; font-size: 1.25rem; cursor: pointer;">√ó</button>
                        </div>

                        <!-- Current Rates -->
                        <div style="padding: 1.5rem; background: #f9fafb;">
                            <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üìã Joriy Komissiya Sozlamalari</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #10b981;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #10b981;">${rates.data?.standard || 15}%</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Standart Komissiya</div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #f59e0b;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #f59e0b;">${rates.data?.premium || 12}%</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Premium Komissiya</div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #3b82f6;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">${rules.data?.length || 0}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Maxsus Qoidalar</div>
                                </div>
                            </div>
                        </div>

                        <!-- Rule Types -->
                        <div style="padding: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üéØ Yangi Komissiya Qoidasi Yaratish</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                                ${rulesGrid}
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="updateCommissionRates()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-edit"></i> Foizlarni o'zgartirish
                            </button>
                            <button onclick="viewCommissionHistory()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-history"></i> Komissiya tarixi
                            </button>
                            <button onclick="exportCommissionReport()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-download"></i> Hisobot yuklash
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

            } catch (error) {
                console.error('Commission management error:', error);
                alert('Komissiya ma\'lumotlarini yuklashda xatolik yuz berdi');
            }
        }

        // Commission rule creation
        async function createCommissionRule(type) {
            const ruleNames = {
                percentage: 'Foizli Komissiya',
                fixed: 'Belgilangan Summa',
                daily: 'Kunlik Komissiya',
                weekly: 'Haftalik Komissiya',
                monthly: 'Oylik Komissiya'
            };

            const value = prompt(`Yangi ${ruleNames[type]} yaratish:\\n\\nQiymatni kiriting:`);
            if (!value || isNaN(value)) return;

            try {
                const response = await fetch('/api/commission/rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: ruleNames[type],
                        type: type,
                        value: parseFloat(value),
                        description: `${ruleNames[type]} - ${value}${type === 'percentage' ? '%' : ' so\'m'}`,
                        isActive: true
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Komissiya qoidasi muvaffaqiyatli yaratildi!');
                    // Refresh the modal
                    document.querySelector('[style*="position: fixed"]').remove();
                    showCommissionManagement();
                } else {
                    alert('Xatolik: ' + result.message);
                }
            } catch (error) {
                console.error('Create rule error:', error);
                alert('Qoida yaratishda xatolik yuz berdi');
            }
        }

        // Placeholder functions for commission actions
        function updateCommissionRates() {
            const standard = prompt('Standart komissiya foizi (hozirgi: 15%):');
            const premium = prompt('Premium komissiya foizi (hozirgi: 12%):');
            if (standard && premium) {
                // Update rates via API
                alert('Komissiya foizlari yangilandi!');
            }
        }

        function viewCommissionHistory() {
            alert('Komissiya tarixi - tez orada...');
        }

        function exportCommissionReport() {
            alert('Komissiya hisoboti yuklash - tez orada...');
        }

        // Initialize autocomplete for both fields
        console.log('Initializing autocomplete...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up autocomplete');
            setupAutocomplete('fromCity', 'fromCitySuggestions');
            setupAutocomplete('toCity', 'toCitySuggestions');

            // Add event listeners for route calculation
            const fromCityInput = document.getElementById('fromCity');
            const toCityInput = document.getElementById('toCity');
            if (fromCityInput) fromCityInput.addEventListener('input', updateRouteInfo);
            if (toCityInput) toCityInput.addEventListener('input', updateRouteInfo);
        });
    </script>

    <!-- Leaflet Map Library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Role Management System -->
    <script src="js/role-manager.js"></script>
</body>
</html>